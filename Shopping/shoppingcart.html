<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>購物車 - PikaBaby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/cart.css">
</head>

<body>
    <header>
        <!-- 置頂的促銷訊息 -->
        <div class="top-banner">
            每週五六日🔥新人代理寄賣免運
            <font color="red"><span></span> 日 <span></span> 時 <span></span> 分 <span></span> 秒</font>
            <div style="display: inline-block; background-color: black; color: white">
                Ispian love you
            </div>
        </div>

        <!-- LOGO -->
        <div class="nav-logo-row">
            <img src="../images/logo-pikababy.png" alt="PikaBaby" class="nav-logo" />
        </div>
    </header>

    <!-- 導覽列 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- <div class="collapse navbar-collapse justify-content-center d-flex" id="navbarSupportedContent"> -->
            <div class="collapse navbar-collapse justify-content-around d-flex" id="navbarSupportedContent">
                <!-- LOGO -->
                <img id="logo" src="../images/logo-pikababy.png" alt="PikaBaby"
                    style="height: 80px; width: 0px; transition: 3s; display: none;" />
                <ul class="navbar-nav ml-auto nav-links gap-5 me-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../index.html">首頁</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown1" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(0-3M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown1">
                            <a class="dropdown-item" href="../Products/product.html?category=14">奶瓶/奶嘴</a>
                            <a class="dropdown-item" href="../Products/product.html?category=15">圍兜/揹巾</a>
                            <a class="dropdown-item" href="../Products/product.html?category=1">嬰兒服裝</a>
                            <a class="dropdown-item" href="../Products/product.html?category=16">清潔用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">嬰兒床</a>
                            <a class="dropdown-item" href="../Products/product.html?category=17">哺乳用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown2" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(3-6M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown2">
                            <a class="dropdown-item" href="../Products/product.html?category=1">嬰兒服裝</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">嬰兒床</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">汽座</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown3" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(6-12M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown3">
                            <a class="dropdown-item" href="../Products/product.html?category=7">學步用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=18">餐具用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=8">幼兒服裝</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">汽座</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown4" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(2-3y)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown4">
                            <a class="dropdown-item" href="../Products/product.html?category=9">幼教用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=10">兒童服裝</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">汽座</a>
                            <a class="dropdown-item" href="../Products/product.html?category=11">兒童推車</a>
                            <a class="dropdown-item" href="../Products/product.html?category=12">餐椅</a>
                            <a class="dropdown-item" href="../Products/product.html?category=13">電器用品</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            二手託售
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center gap-5" aria-labelledby="navbarDropdown5">
                            <a class="dropdown-item" href="../Secondhand/consign.html">託售服務</a>
                            <a class="dropdown-item" href="../Secondhand/consign_apply.html">二手託售申請</a>
                            <a class="dropdown-item" href="../Secondhand/consign_search.html">託售紀錄查詢</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_apply.html">託售提款申請</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_search.html">提款紀錄查詢</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../about.html">關於我們</a>
                    </li>
                    <div class="d-flex gap-3">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="../Shopping/shoppingcart.html">
                                <img src="../images/cart.png" style="width: 30px;">
                            </a>
                            <!-- <div class="dropdown-menu p-3 justify-content-center gap-5"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="Shopping/shoppingcart.html">購物車</a>
                                <a class="dropdown-item" href="Shopping/order.html">訂單查詢</a>
                            </div> -->
                        </li>
                        <!-- ✅ 未登入時：跳 login，不顯示 dropdown -->
                        <li class="nav-item" id="loginNavItem">
                            <a class="nav-link" href="../Member/login.html">
                                <img src="../images/user.png" style="width: 30px;" alt="會員登入圖示">
                            </a>
                        </li>
                        <!-- ✅ 已登入時：正常 dropdown -->
                        <li class="nav-item dropdown" id="memberDropdownItem" style="display: none;">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img src="../images/user.png" style="width: 30px;" alt="會員圖示">
                            </a>
                            <div class="dropdown-menu p-3 justify-content-center gap-5" id="dropdownForUser"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="../Member/member.html">會員中心</a>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">登出</a>
                            </div>
                        </li>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main style="background: #fff; padding: 20px 0; min-height: fit-content;">
        <div class="cart-container">
            <div class="cart-main-row">
                <!-- 購物車內容 -->
                <div id="cartContent">
                    <h2 style="color: rgb(95, 76, 0); text-align: center;">購物車</h2>
                    <table class="cart-table" id="cart-table">
                        <thead>
                            <tr>
                                <th>商品圖片</th>
                                <th>商品名稱</th>
                                <th>單價</th>
                                <th>數量</th>
                                <th>小計</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4"></td>
                                <td style="font-size: 1.2em; font-weight: bold; border-bottom: none;" id="cart-total">
                                    總計：NT$ 0</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="6" style="padding-top: 0; border-bottom: none;">
                                    <div class="d-flex justify-content-end align-items-center gap-2 cart-action-row">
                                        <button class="btn btn-success" onclick="continueShopping()">繼續購物</button>
                                        <button class="btn btn-primary" onclick="checkLoginAndProceed()">前往結帳</button>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <!-- 結帳表單移出 cart-main-row，直接放在 cart-container 下方 -->
            <div id="checkoutForm" style="display: none;">
                <h2 style="color: rgb(95, 76, 0); text-align: center;">結帳資訊</h2>
                <!-- 訂單摘要 -->
                <div class="order-summary">
                    <table class="cart-table" id="checkout-table">
                        <thead>
                            <tr>
                                <th><img src="../images/pikababy.png" alt="商品圖片" style="height:32px;"></th>
                                <th>商品名稱</th>
                                <th>單價</th>
                                <th>數量</th>
                                <th>小計</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="orderItems"></tbody>
                    </table>
                    <div class="total-section">
                        <div class="mb-2">商品總額：<span id="orderSubtotal">0</span> 元</div>
                        <div class="mb-2">運費：<span id="shippingFee">0</span> 元</div>
                        <div class="mb-2">優惠折扣：<span id="discount">0</span> 元</div>
                        <div class="mb-2">
                            <label for="points">使用會員點數折價 (1點折1元)：</label>
                            <input type="number" id="points" min="0" value="0" onchange="validateAndUpdatePoints()"
                                style="width: 80px;"><br>
                            <span style="margin-left:8px;color:#e6b800;">剩餘點數：<span id="availablePoints">載入中...</span>
                                點</span>
                            <div id="pointsError" style="color: red; font-size: 12px; margin-top: 4px; display: none;">
                            </div>
                        </div>
                        <div class="h5">應付總額：<span id="orderTotal">0</span> 元</div>
                    </div>
                </div>

                <!-- 加購商品選項 -->
                <div class="checkout-addons">
                    <div class="checkout-addons-title">加購商品推薦</div>
                    <div class="checkout-addon-list">
                        <div class="checkout-addon-item">
                            <img src="../images/product1.jpg" alt="加購商品A">
                            <div>加購商品A</div>
                            <div>NT$ 99</div>
                            <button class="btn btn-sm btn-primary" id="addonA-btn"
                                onclick="addAddonToCart('加購商品A', 99, '../images/product1.jpg', this, 1)">加入購物車</button>
                        </div>
                        <div class="checkout-addon-item">
                            <img src="../images/product2.jpg" alt="加購商品B">
                            <div>加購商品B</div>
                            <div>NT$ 150</div>
                            <button class="btn btn-sm btn-primary" id="addonB-btn"
                                onclick="addAddonToCart('加購商品B', 150, '../images/product2.jpg', this, 2)">加入購物車</button>
                        </div>
                    </div>
                </div>

                <!-- 收件資訊表單 -->
                <form id="orderForm" onsubmit="submitOrder(event)" style="width:100%;max-width:600px;margin:0 auto;">
                    <!-- 會員資料自動帶入選項 -->
                    <div class="mb-4 p-3"
                        style="background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 32px;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useMemberData"
                                onchange="toggleMemberData()">
                            <label class="form-check-label fw-bold" for="useMemberData" style="color: #0d6efd;">
                                使用會員資料作為收件人資訊
                            </label>
                        </div>
                        <small class="text-muted">勾選此選項將自動帶入您的會員資料，並鎖定收件人欄位</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">收件人姓名</label>
                        <input type="text" class="form-control" name="name" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">聯絡電話</label>
                        <input type="tel" class="form-control" name="phone" id="recipientPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="recipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">收件地址</label>
                        <input type="text" class="form-control" name="address" id="recipientAddress" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">付款方式</label>
                        <select class="form-select" name="paymentMethod" required>
                            <option value="">請選擇付款方式</option>
                            <option value="ecpay">💳 信用卡</option>
                            <option value="transfer">🏦 銀行轉帳</option>
                            <option value="linepay">💚 LINE Pay</option>
                        </select>
                        <small class="text-muted">
                            選擇 LINE Pay 將跳轉至 LINE 官方付款頁面進行安全付款
                        </small>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="hideCheckoutForm()">返回購物車</button>
                        <button type="submit" class="btn btn-primary">確認送出</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- 頁尾 -->
    <footer>
        <div class="footer-container align-items-center">
            <div class="footer-section" style="flex: 0;">
                <img src="../images/logo-pikababy.png" alt="PikaBaby" class="footer-logo" />
            </div>
            <div class="footer-section w-100">
                <p class="footer-title">PikaBaby</p>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/index.html">HOME</a>
                </p>
                <p class="mb-1">
                    <a href="/about.html">關於我們</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>品牌服務</h3>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/Products/product.html">Baby Store</a>
                </p>
                <p class="mb-1">
                    <a href="/Secondhand/consign.html">二手託售</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>聯絡我們</h3>
                <div class="footer-line"></div>
                <p class="mb-1">聯絡電話：(04) 2326-5860</p>
                <p class="mb-1">聯絡地址：台中市南屯區公益路二段51號18樓</p>
            </div>
        </div>
    </footer>

    <!-- 奶瓶 -->
    <div class="floating-bottle"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/navbar.js"></script>
    <script src="../js/logout.js"></script>
    <script src="../js/usernoToggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            //若有登入會員，下拉選單顯示
            $.ajax({
                method: "GET",
                url: "http://localhost:8080/customers/front/me",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    setUserToggle(data);
                },
                error: function () {
                    console.log("未登入");
                }
            })

            await loadCart();

            // 檢查是否需要直接顯示結帳表單（從登入頁面返回）
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('checkout') === 'true') {
                // 清理URL參數
                window.history.replaceState({}, document.title, window.location.pathname);
                // 延遲一點再顯示結帳表單，確保頁面渲染完成
                setTimeout(async () => {
                    await showCheckoutForm();
                }, 100);
            }

            // 檢查 LINE Pay 取消付款的情況
            if (urlParams.get('linepay') === 'cancelled') {
                // 恢復購物車資料
                const pendingOrderData = localStorage.getItem('pendingOrder');
                if (pendingOrderData) {
                    const orderData = JSON.parse(pendingOrderData);
                    if (orderData.cart) {
                        localStorage.setItem('cart', JSON.stringify(orderData.cart));
                        await loadCart(); // 重新載入購物車
                    }
                }
                localStorage.removeItem('pendingOrder');

                // 清理URL參數並顯示提示
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('LINE Pay 付款已取消，商品已恢復到購物車中。');
            }

            // 會員點數將在顯示結帳表單時動態載入
            // 檢查加購商品按鈕狀態
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.find(item => item.name === '加購商品A')) {
                const btnA = document.getElementById('addonA-btn');
                if (btnA) { btnA.disabled = true; btnA.textContent = '已加入購物車'; }
            }
            if (cart.find(item => item.name === '加購商品B')) {
                const btnB = document.getElementById('addonB-btn');
                if (btnB) { btnB.disabled = true; btnB.textContent = '已加入購物車'; }
            }
        })
    </script>
</body>

</html>