<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è³¼ç‰©è»Š - PikaBaby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/nav.css">
    <style>
        /* è³¼ç‰©è»Šæ¨£å¼ */
        .cart-container {
            max-width: 1500px;
            margin: 20px auto;
            padding: 20px;
        }

        .cart-table {
            width: 100%;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .cart-table th,
        .cart-table td {
            padding: 18px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #ddd;
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        .cart-item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-info {
            text-align: left;
        }

        .product-name {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .product-specs {
            font-size: 0.9em;
            color: #666;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .quantity-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }

        .quantity-display {
            padding: 5px 15px;
            border: 1px solid #ddd;
            min-width: 50px;
            text-align: center;
        }

        .checkout-form-wrapper {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
            box-sizing: border-box;
        }

        .checkout-form {
            display: block;
            max-width: 1200px;
            margin: 40px auto;
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0 32px;
            text-align: center;
        }

        #checkoutForm>* {
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .order-summary,
        .checkout-addons,
        #orderForm {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        #orderForm {
            margin-left: auto;
            margin-right: auto;
        }

        .order-summary {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            background: white;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 20px;
            padding: 20px 0;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item-image {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }

        .order-item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .order-item-details {
            flex-grow: 1;
        }

        .order-item-price {
            text-align: right;
            min-width: 100px;
        }

        .total-section {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .checkout-addons {
            width: 100%;
            margin: 30px 0 0 0;
            background: #fffbe6;
            border-radius: 8px;
            padding: 20px 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            text-align: center;
        }

        .checkout-addons-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .checkout-addon-list {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .checkout-addon-item {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            padding: 12px 16px;
            width: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .checkout-addon-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .checkout-addon-item button {
            margin-top: 8px;
        }

        .checkout-addon-item button:disabled {
            background: #ccc !important;
            border-color: #ccc !important;
            cursor: not-allowed;
        }

        .cart-main-row {
            display: flex;
            align-items: flex-start;
            gap: 40px;
        }

        #cartContent {
            flex: 1 1 0%;
        }

        .recommendations {
            flex: 0 0 300px;
            min-width: 250px;
            margin-left: auto;
            text-align: right;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        @media (max-width: 900px) {
            .cart-main-row {
                flex-direction: column;
            }

            .recommendations {
                margin-left: 0;
                text-align: center;
            }
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .cart-table tfoot td {
            border-bottom: none !important;
        }

        .cart-action-row {
            margin-top: 0;
            margin-bottom: 20px;
            /* å¯ä¾éœ€æ±‚èª¿æ•´ */
        }

        @media (max-width: 991.98px) {
            .navbar-collapse.show {
                background-color: #f5e6c8 !important;
                border-radius: 0 0 12px 12px;
            }

            .navbar-collapse .mobile-logo {
                display: none;
            }

            .navbar-collapse.show .mobile-logo {
                display: block !important;
            }
        }

        @media (min-width: 992px) {
            .mobile-logo {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <!-- ç½®é ‚çš„ä¿ƒéŠ·è¨Šæ¯ -->
        <div class="top-banner">
            æ¯é€±äº”å…­æ—¥ğŸ”¥æ–°äººä»£ç†å¯„è³£å…é‹
            <font color="red"><span></span> æ—¥ <span></span> æ™‚ <span></span> åˆ† <span></span> ç§’</font>
            <div style="display: inline-block; background-color: black; color: white">
                Ispian love you
            </div>
        </div>

        <!-- LOGO -->
        <div class="nav-logo-row">
            <img src="../images/logo-pikababy.png" alt="PikaBaby" class="nav-logo" />
        </div>
    </header>

    <!-- å°è¦½åˆ— -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- <div class="collapse navbar-collapse justify-content-center d-flex" id="navbarSupportedContent"> -->
            <div class="collapse navbar-collapse justify-content-around d-flex" id="navbarSupportedContent">
                <!-- LOGO -->
                <img id="logo" src="../images/logo-pikababy.png" alt="PikaBaby"
                    style="height: 80px; width: 0px; transition: 3s; display: none;" />
                <ul class="navbar-nav ml-auto nav-links gap-5 me-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../index.html">é¦–é </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown1" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            å¹´é½¡å€é–“(0-3M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown1">
                            <a class="dropdown-item" href="../Products/product.html?category=14">å¥¶ç“¶/å¥¶å˜´</a>
                            <a class="dropdown-item" href="../Products/product.html?category=15">åœå…œ/æ¹å·¾</a>
                            <a class="dropdown-item" href="../Products/product.html?category=1">å¬°å…’æœè£</a>
                            <a class="dropdown-item" href="../Products/product.html?category=16">æ¸…æ½”ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">å¬°å…’æ¨è»Š</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">å¬°å…’åºŠ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=17">å“ºä¹³ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">å¬°å…’ç”¨å“</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown2" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            å¹´é½¡å€é–“(3-6M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown2">
                            <a class="dropdown-item" href="../Products/product.html?category=1">å¬°å…’æœè£</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">ç©å…·</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">å¬°å…’æ¨è»Š</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">å¬°å…’åºŠ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">æ±½åº§</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">å¬°å…’ç”¨å“</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown3" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            å¹´é½¡å€é–“(6-12M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown3">
                            <a class="dropdown-item" href="../Products/product.html?category=7">å­¸æ­¥ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=18">é¤å…·ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=8">å¹¼å…’æœè£</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">ç©å…·</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">å¬°å…’æ¨è»Š</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">æ±½åº§</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">å¬°å…’ç”¨å“</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown4" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            å¹´é½¡å€é–“(2-3y)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown4">
                            <a class="dropdown-item" href="../Products/product.html?category=9">å¹¼æ•™ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=10">å…’ç«¥æœè£</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">ç©å…·</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">æ±½åº§</a>
                            <a class="dropdown-item" href="../Products/product.html?category=11">å…’ç«¥æ¨è»Š</a>
                            <a class="dropdown-item" href="../Products/product.html?category=12">é¤æ¤…</a>
                            <a class="dropdown-item" href="../Products/product.html?category=13">é›»å™¨ç”¨å“</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">å¬°å…’ç”¨å“</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            äºŒæ‰‹è¨—å”®
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center gap-5" aria-labelledby="navbarDropdown5">
                            <a class="dropdown-item" href="../Secondhand/consign.html">è¨—å”®æœå‹™</a>
                            <a class="dropdown-item" href="../Secondhand/consign_apply.html">äºŒæ‰‹è¨—å”®ç”³è«‹</a>
                            <a class="dropdown-item" href="../Secondhand/consign_search.html">è¨—å”®ç´€éŒ„æŸ¥è©¢</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_apply.html">è¨—å”®ææ¬¾ç”³è«‹</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_search.html">ææ¬¾ç´€éŒ„æŸ¥è©¢</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../about.html">é—œæ–¼æˆ‘å€‘</a>
                    </li>
                    <div class="d-flex gap-3">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="../Shopping/shoppingcart.html">
                                <img src="../images/cart.png" style="width: 30px;">
                            </a>
                            <!-- <div class="dropdown-menu p-3 justify-content-center gap-5"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="Shopping/shoppingcart.html">è³¼ç‰©è»Š</a>
                                <a class="dropdown-item" href="Shopping/order.html">è¨‚å–®æŸ¥è©¢</a>
                            </div> -->
                        </li>
                        <!-- âœ… æœªç™»å…¥æ™‚ï¼šè·³ loginï¼Œä¸é¡¯ç¤º dropdown -->
                        <li class="nav-item" id="loginNavItem">
                            <a class="nav-link" href="../Member/login.html">
                                <img src="../images/user.png" style="width: 30px;" alt="æœƒå“¡ç™»å…¥åœ–ç¤º">
                            </a>
                        </li>
                        <!-- âœ… å·²ç™»å…¥æ™‚ï¼šæ­£å¸¸ dropdown -->
                        <li class="nav-item dropdown" id="memberDropdownItem" style="display: none;">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img src="../images/user.png" style="width: 30px;" alt="æœƒå“¡åœ–ç¤º">
                            </a>
                            <div class="dropdown-menu p-3 justify-content-center gap-5" id="dropdownForUser"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="../Member/member.html">æœƒå“¡ä¸­å¿ƒ</a>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">ç™»å‡º</a>
                            </div>
                        </li>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main style="background: #fff; padding: 20px 0; min-height: fit-content;">
        <div class="cart-container">
            <div class="cart-main-row">
                <!-- è³¼ç‰©è»Šå…§å®¹ -->
                <div id="cartContent">
                    <h2 style="color: rgb(95, 76, 0); text-align: center;">è³¼ç‰©è»Š</h2>
                    <table class="cart-table" id="cart-table">
                        <thead>
                            <tr>
                                <th>å•†å“åœ–ç‰‡</th>
                                <th>å•†å“åç¨±</th>
                                <th>å–®åƒ¹</th>
                                <th>æ•¸é‡</th>
                                <th>å°è¨ˆ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4"></td>
                                <td style="font-size: 1.2em; font-weight: bold; border-bottom: none;" id="cart-total">
                                    ç¸½è¨ˆï¼šNT$ 0</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="6" style="padding-top: 0; border-bottom: none;">
                                    <div class="d-flex justify-content-end align-items-center gap-2 cart-action-row">
                                        <button class="btn btn-success" onclick="continueShopping()">ç¹¼çºŒè³¼ç‰©</button>
                                        <button class="btn btn-primary" onclick="checkLoginAndProceed()">å‰å¾€çµå¸³</button>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <!-- çµå¸³è¡¨å–®ç§»å‡º cart-main-rowï¼Œç›´æ¥æ”¾åœ¨ cart-container ä¸‹æ–¹ -->
            <div id="checkoutForm" style="display: none;">
                <h2 style="color: rgb(95, 76, 0); text-align: center;">çµå¸³è³‡è¨Š</h2>
                <!-- è¨‚å–®æ‘˜è¦ -->
                <div class="order-summary">
                    <table class="cart-table" id="checkout-table">
                        <thead>
                            <tr>
                                <th><img src="../images/pikababy.png" alt="å•†å“åœ–ç‰‡" style="height:32px;"></th>
                                <th>å•†å“åç¨±</th>
                                <th>å–®åƒ¹</th>
                                <th>æ•¸é‡</th>
                                <th>å°è¨ˆ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="orderItems"></tbody>
                    </table>
                    <div class="total-section">
                        <div class="mb-2">å•†å“ç¸½é¡ï¼š<span id="orderSubtotal">0</span> å…ƒ</div>
                        <div class="mb-2">é‹è²»ï¼š<span id="shippingFee">0</span> å…ƒ</div>
                        <div class="mb-2">å„ªæƒ æŠ˜æ‰£ï¼š<span id="discount">0</span> å…ƒ</div>
                        <div class="mb-2">
                            <label for="points">ä½¿ç”¨æœƒå“¡é»æ•¸æŠ˜åƒ¹ (1é»æŠ˜1å…ƒ)ï¼š</label>
                            <input type="number" id="points" min="0" value="0" onchange="validateAndUpdatePoints()"
                                style="width: 80px;"><br>
                            <span style="margin-left:8px;color:#e6b800;">å‰©é¤˜é»æ•¸ï¼š<span id="availablePoints">è¼‰å…¥ä¸­...</span>
                                é»</span>
                            <div id="pointsError" style="color: red; font-size: 12px; margin-top: 4px; display: none;">
                            </div>
                        </div>
                        <div class="h5">æ‡‰ä»˜ç¸½é¡ï¼š<span id="orderTotal">0</span> å…ƒ</div>
                    </div>
                </div>

                <!-- åŠ è³¼å•†å“é¸é … -->
                <div class="checkout-addons">
                    <div class="checkout-addons-title">åŠ è³¼å•†å“æ¨è–¦</div>
                    <div class="checkout-addon-list">
                        <div class="checkout-addon-item">
                            <img src="../images/product1.jpg" alt="åŠ è³¼å•†å“A">
                            <div>åŠ è³¼å•†å“A</div>
                            <div>NT$ 99</div>
                            <button class="btn btn-sm btn-primary" id="addonA-btn"
                                onclick="addAddonToCart('åŠ è³¼å•†å“A', 99, '../images/product1.jpg', this, 1)">åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                        <div class="checkout-addon-item">
                            <img src="../images/product2.jpg" alt="åŠ è³¼å•†å“B">
                            <div>åŠ è³¼å•†å“B</div>
                            <div>NT$ 150</div>
                            <button class="btn btn-sm btn-primary" id="addonB-btn"
                                onclick="addAddonToCart('åŠ è³¼å•†å“B', 150, '../images/product2.jpg', this, 2)">åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                    </div>
                </div>

                <!-- æ”¶ä»¶è³‡è¨Šè¡¨å–® -->
                <form id="orderForm" onsubmit="submitOrder(event)" style="width:100%;max-width:600px;margin:0 auto;">
                    <!-- æœƒå“¡è³‡æ–™è‡ªå‹•å¸¶å…¥é¸é … -->
                    <div class="mb-4 p-3"
                        style="background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 32px;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useMemberData"
                                onchange="toggleMemberData()">
                            <label class="form-check-label fw-bold" for="useMemberData" style="color: #0d6efd;">
                                ä½¿ç”¨æœƒå“¡è³‡æ–™ä½œç‚ºæ”¶ä»¶äººè³‡è¨Š
                            </label>
                        </div>
                        <small class="text-muted">å‹¾é¸æ­¤é¸é …å°‡è‡ªå‹•å¸¶å…¥æ‚¨çš„æœƒå“¡è³‡æ–™ï¼Œä¸¦é–å®šæ”¶ä»¶äººæ¬„ä½</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ”¶ä»¶äººå§“å</label>
                        <input type="text" class="form-control" name="name" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è¯çµ¡é›»è©±</label>
                        <input type="tel" class="form-control" name="phone" id="recipientPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="recipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ”¶ä»¶åœ°å€</label>
                        <input type="text" class="form-control" name="address" id="recipientAddress" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
                        <select class="form-select" name="paymentMethod" required>
                            <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                            <option value="ecpay">ğŸ’³ ä¿¡ç”¨å¡</option>
                            <option value="transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</option>
                            <option value="linepay">ğŸ’š LINE Pay</option>
                        </select>
                        <small class="text-muted">
                            é¸æ“‡ LINE Pay å°‡è·³è½‰è‡³ LINE å®˜æ–¹ä»˜æ¬¾é é¢é€²è¡Œå®‰å…¨ä»˜æ¬¾
                        </small>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="hideCheckoutForm()">è¿”å›è³¼ç‰©è»Š</button>
                        <button type="submit" class="btn btn-primary">ç¢ºèªé€å‡º</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- é å°¾ -->
    <footer>
        <div class="footer-container align-items-center">
            <div class="footer-section" style="flex: 0;">
                <img src="../images/logo-pikababy.png" alt="PikaBaby" class="footer-logo" />
            </div>
            <div class="footer-section w-100">
                <p class="footer-title">PikaBaby</p>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/index.html">HOME</a>
                </p>
                <p class="mb-1">
                    <a href="/about.html">é—œæ–¼æˆ‘å€‘</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>å“ç‰Œæœå‹™</h3>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/Products/product.html">Baby Store</a>
                </p>
                <p class="mb-1">
                    <a href="/Secondhand/consign.html">äºŒæ‰‹è¨—å”®</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>è¯çµ¡æˆ‘å€‘</h3>
                <div class="footer-line"></div>
                <p class="mb-1">è¯çµ¡é›»è©±ï¼š(04) 2326-5860</p>
                <p class="mb-1">è¯çµ¡åœ°å€ï¼šå°ä¸­å¸‚å—å±¯å€å…¬ç›Šè·¯äºŒæ®µ51è™Ÿ18æ¨“</p>
            </div>
        </div>
    </footer>

    <!-- å¥¶ç“¶ -->
    <div class="floating-bottle"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/navbar.js"></script>
    <script src="../js/logout.js"></script>
    <script src="../js/usernoToggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            //è‹¥æœ‰ç™»å…¥æœƒå“¡ï¼Œä¸‹æ‹‰é¸å–®é¡¯ç¤º
            $.ajax({
                method: "GET",
                url: "http://localhost:8080/customers/front/me",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    setUserToggle(data);
                },
                error: function () {
                    console.log("æœªç™»å…¥");
                }
            })
        })

        let stockMap = {};
        let cartItems = [];

        // æª¢æŸ¥æœƒå“¡ç™»å…¥ç‹€æ…‹ä¸¦é€²è¡Œçµå¸³
        async function checkLoginAndProceed() {
            try {
                // æª¢æŸ¥æœƒå“¡ç™»å…¥ç‹€æ…‹
                const response = await fetch('http://localhost:8080/customers/check-login', {
                    method: 'GET',
                    credentials: 'include' // åŒ…å« Session cookie
                });

                if (response.ok) {
                    const loginStatus = await response.json();

                    if (loginStatus.isLoggedIn) {
                        // å·²ç™»å…¥ï¼Œç›´æ¥é€²å…¥çµå¸³æµç¨‹
                        console.log('âœ… æœƒå“¡å·²ç™»å…¥ï¼Œé€²å…¥çµå¸³æµç¨‹');
                        await showCheckoutForm();
                    } else {
                        // æœªç™»å…¥ï¼Œæç¤ºç™»å…¥
                        showLoginPrompt();
                    }
                } else {
                    // APIéŒ¯èª¤ï¼Œæš«æ™‚å…è¨±çµå¸³ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
                    console.warn('âš ï¸ ç„¡æ³•æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼Œå…è¨±çµå¸³');
                    await showCheckoutForm();
                }
            } catch (error) {
                console.error('âŒ æª¢æŸ¥ç™»å…¥ç‹€æ…‹å¤±æ•—:', error);
                // ç¶²è·¯éŒ¯èª¤ï¼Œæš«æ™‚å…è¨±çµå¸³
                await showCheckoutForm();
            }
        }

        // é¡¯ç¤ºç™»å…¥æç¤º
        function showLoginPrompt() {
            const loginConfirm = confirm(
                'è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½é€²è¡Œçµå¸³ï¼\n\n' +
                'é»æ“Šã€Œç¢ºå®šã€å‰å¾€ç™»å…¥é é¢\n' +
                'é»æ“Šã€Œå–æ¶ˆã€ç¹¼çºŒç€è¦½å•†å“'
            );

            if (loginConfirm) {
                // å„²å­˜ç•¶å‰é é¢åˆ°ç™»å…¥å¾Œè¿”å›
                sessionStorage.setItem('returnToCheckout', 'true');
                window.location.href = '../Member/login.html';
            }
        }

        // ç•¶é é¢åŠ è¼‰æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', async function () {
            await loadCart();

            // æª¢æŸ¥æ˜¯å¦éœ€è¦ç›´æ¥é¡¯ç¤ºçµå¸³è¡¨å–®ï¼ˆå¾ç™»å…¥é é¢è¿”å›ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('checkout') === 'true') {
                // æ¸…ç†URLåƒæ•¸
                window.history.replaceState({}, document.title, window.location.pathname);
                // å»¶é²ä¸€é»å†é¡¯ç¤ºçµå¸³è¡¨å–®ï¼Œç¢ºä¿é é¢æ¸²æŸ“å®Œæˆ
                setTimeout(async () => {
                    await showCheckoutForm();
                }, 100);
            }

            // æª¢æŸ¥ LINE Pay å–æ¶ˆä»˜æ¬¾çš„æƒ…æ³
            if (urlParams.get('linepay') === 'cancelled') {
                // æ¢å¾©è³¼ç‰©è»Šè³‡æ–™
                const pendingOrderData = localStorage.getItem('pendingOrder');
                if (pendingOrderData) {
                    const orderData = JSON.parse(pendingOrderData);
                    if (orderData.cart) {
                        localStorage.setItem('cart', JSON.stringify(orderData.cart));
                        await loadCart(); // é‡æ–°è¼‰å…¥è³¼ç‰©è»Š
                    }
                }
                localStorage.removeItem('pendingOrder');

                // æ¸…ç†URLåƒæ•¸ä¸¦é¡¯ç¤ºæç¤º
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('LINE Pay ä»˜æ¬¾å·²å–æ¶ˆï¼Œå•†å“å·²æ¢å¾©åˆ°è³¼ç‰©è»Šä¸­ã€‚');
            }

            // æœƒå“¡é»æ•¸å°‡åœ¨é¡¯ç¤ºçµå¸³è¡¨å–®æ™‚å‹•æ…‹è¼‰å…¥
            // æª¢æŸ¥åŠ è³¼å•†å“æŒ‰éˆ•ç‹€æ…‹
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.find(item => item.name === 'åŠ è³¼å•†å“A')) {
                const btnA = document.getElementById('addonA-btn');
                if (btnA) { btnA.disabled = true; btnA.textContent = 'å·²åŠ å…¥è³¼ç‰©è»Š'; }
            }
            if (cart.find(item => item.name === 'åŠ è³¼å•†å“B')) {
                const btnB = document.getElementById('addonB-btn');
                if (btnB) { btnB.disabled = true; btnB.textContent = 'å·²åŠ å…¥è³¼ç‰©è»Š'; }
            }
        });

        // å¾ localStorage åŠ è¼‰è³¼ç‰©è»Šæ•¸æ“šä¸¦åŒæ­¥å•†å“è³‡è¨Š
        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartContainer = document.getElementById('cart-items');
            cartContainer.innerHTML = '';
            let total = 0;
            // æŸ¥è©¢æ‰€æœ‰å•†å“åº«å­˜
            stockMap = {};
            await Promise.all(cart.map(async (item) => {
                try {
                    const response = await fetch(`http://localhost:8080/products/api/stock/${item.id}`);
                    if (response.ok) {
                        const stockData = await response.json();
                        stockMap[item.id] = stockData.stock || 0;
                    } else {
                        stockMap[item.id] = 99; // æŸ¥è©¢å¤±æ•—çµ¦å¤§å€¼
                    }
                } catch {
                    stockMap[item.id] = 99;
                }
            }));
            cart.forEach((item, idx) => {
                const imgSrc = item.image && item.image.trim() !== '' ? item.image : 'https://via.placeholder.com/80x80?text=No+Image';
                const disableMinus = item.quantity <= 1 ? 'disabled' : '';
                const disablePlus = item.quantity >= stockMap[item.id] ? 'disabled' : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${imgSrc}" alt="${item.name}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;" onerror="this.src='../images/baby.jpg';"></td>
                    <td>${item.name}</td>
                    <td>NT$${item.price}</td>
                    <td>
                        <div style="display:flex;align-items:center;justify-content:center;gap:4px;">
                            <button type="button" onclick="updateQuantity(${idx}, -1)" class="btn btn-sm btn-outline-secondary" ${disableMinus}>-</button>
                            <span id="qty-display-${idx}" style="display:inline-block;width:60px;text-align:center;line-height:32px;">${item.quantity}</span>
                            <button id="plus-btn-${idx}" type="button" onclick="updateQuantity(${idx}, 1)" class="btn btn-sm btn-outline-secondary" ${disablePlus}>+</button>
                        </div>
                        <div style='font-size:0.9em;color:#b8860b;margin-top:2px;'>åº«å­˜åƒ…å‰©${stockMap[item.id]}ä»¶</div>
                    </td>
                    <td>NT$${item.price * item.quantity}</td>
                    <td><button onclick="removeItem(${idx})"  class="btn btn-danger">åˆªé™¤</button></td>
                `;
                cartContainer.appendChild(row);
                total += item.price * item.quantity;
                updatePlusMinusBtnState(row, item.quantity, stockMap[item.id]);
            });
            document.getElementById('cart-total').textContent = `ç¸½è¨ˆï¼šNT$ ${total}`;
        }

        // åŒæ­¥è³¼ç‰©è»Šå•†å“è³‡è¨Šèˆ‡è³‡æ–™åº«
        async function syncCartWithDatabase(cart) {
            const updatedCart = [];

            for (const item of cart) {
                try {
                    // å¾å¾Œç«¯ç²å–æœ€æ–°çš„å•†å“è³‡è¨Š
                    const response = await fetch(`http://localhost:8080/products/front/detail/${item.id}`);

                    if (response.ok) {
                        const productData = await response.json();
                        if (productData.success) {
                            // æ›´æ–°å•†å“è³‡è¨Šï¼Œä¿ç•™è³¼ç‰©è»Šä¸­çš„æ•¸é‡
                            const updatedItem = {
                                id: item.id,
                                name: productData.name,
                                price: productData.price,
                                quantity: item.quantity,
                                image: productData.primaryImageUrl ?
                                    (productData.primaryImageUrl.startsWith('/products/front/images/') ?
                                        'http://localhost:8080' + productData.primaryImageUrl :
                                        productData.primaryImageUrl) :
                                    '../images/baby.jpg'
                            };
                            updatedCart.push(updatedItem);
                            console.log(`âœ… å·²æ›´æ–°å•†å“è³‡è¨Š: ${productData.name}`);
                        } else {
                            console.warn(`âš ï¸ å•†å“ ${item.name} (ID: ${item.id}) å¯èƒ½å·²ä¸‹æ¶æˆ–åº«å­˜ä¸è¶³ï¼Œä¿ç•™åŸè³‡è¨Š`);
                            updatedCart.push(item);
                        }
                    } else {
                        console.warn(`âš ï¸ ç„¡æ³•ç²å–å•†å“ ${item.name} (ID: ${item.id}) çš„æœ€æ–°è³‡è¨Šï¼Œä¿ç•™åŸè³‡è¨Š`);
                        updatedCart.push(item);
                    }
                } catch (error) {
                    console.error(`âŒ åŒæ­¥å•†å“ ${item.name} (ID: ${item.id}) æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                    updatedCart.push(item);
                }
            }

            return updatedCart;
        }

        function onQuantityInput(idx, value) {
            // æ­¤åŠŸèƒ½å·²ç§»é™¤ï¼Œä¿ç•™ç©ºå‡½å¼é˜²æ­¢éŒ¯èª¤
        }

        async function removeItem(idx) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                await loadCart();
            }
        }

        function goToCheckout() {
            window.location.href = 'checkout.html';
        }

        // é¡¯ç¤ºçµå¸³è¡¨å–®
        async function showCheckoutForm() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');
                return;
            }

            // æ¸²æŸ“è¨‚å–®é …ç›®
            await renderOrderItems(cart);

            // åˆ‡æ›é¡¯ç¤º
            document.getElementById('cartContent').style.display = 'none';
            document.getElementById('checkoutForm').style.display = 'block';

            // åˆå§‹åŒ–æœƒå“¡è³‡æ–™é¸é …
            initializeMemberDataOption();

            // æ›´æ–°æœƒå“¡é»æ•¸é¡¯ç¤º
            updateMemberPoints();

            // æ›´æ–°ç¸½é‡‘é¡
            updateTotal();
        }

        // æœƒå“¡è³‡æ–™å…¨åŸŸè®Šæ•¸
        let memberData = null;
        let memberPoints = 0;

        // æœƒå“¡è³‡æ–™è‡ªå‹•å¸¶å…¥åŠŸèƒ½
        async function initializeMemberDataOption() {
            try {
                const response = await fetch('http://localhost:8080/customers/profile', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    memberData = await response.json();
                    console.log('æœƒå“¡è³‡æ–™è¼‰å…¥æˆåŠŸ:', memberData);

                    // é¡¯ç¤ºå‹¾é¸é¸é …
                    const memberDataOption = document.querySelector('.mb-4.p-3');
                    if (memberDataOption) {
                        memberDataOption.style.display = 'block';
                    }
                } else {
                    console.log('ç„¡æ³•è¼‰å…¥æœƒå“¡è³‡æ–™ï¼Œéš±è—é¸é …');
                    const memberDataOption = document.querySelector('.mb-4.p-3');
                    if (memberDataOption) {
                        memberDataOption.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                const memberDataOption = document.querySelector('.mb-4.p-3');
                if (memberDataOption) {
                    memberDataOption.style.display = 'none';
                }
            }
        }

        // åˆ‡æ›æœƒå“¡è³‡æ–™ä½¿ç”¨ç‹€æ…‹
        function toggleMemberData() {
            const checkbox = document.getElementById('useMemberData');
            const nameField = document.getElementById('recipientName');
            const phoneField = document.getElementById('recipientPhone');
            const emailField = document.getElementById('recipientEmail');
            const addressField = document.getElementById('recipientAddress');

            if (checkbox.checked && memberData) {
                // å¡«å…¥æœƒå“¡è³‡æ–™ä¸¦ç¦ç”¨æ¬„ä½
                nameField.value = memberData.name || '';
                phoneField.value = memberData.phone || '';
                emailField.value = memberData.email || '';
                addressField.value = memberData.address || '';

                // è¨­ç‚ºç¦ç”¨ç‹€æ…‹
                nameField.disabled = true;
                phoneField.disabled = true;
                emailField.disabled = true;
                addressField.disabled = true;

                // è¦–è¦ºæ•ˆæœ
                nameField.style.backgroundColor = '#f8f9fa';
                phoneField.style.backgroundColor = '#f8f9fa';
                emailField.style.backgroundColor = '#f8f9fa';
                addressField.style.backgroundColor = '#f8f9fa';

                console.log('å·²å¸¶å…¥æœƒå“¡è³‡æ–™ä¸¦é–å®šæ¬„ä½');
            } else {
                // æ¸…ç©ºä¸¦å•Ÿç”¨æ¬„ä½
                nameField.value = '';
                phoneField.value = '';
                emailField.value = '';
                addressField.value = '';

                // æ¢å¾©å¯ç·¨è¼¯ç‹€æ…‹
                nameField.disabled = false;
                phoneField.disabled = false;
                emailField.disabled = false;
                addressField.disabled = false;

                // æ¢å¾©åŸå§‹æ¨£å¼
                nameField.style.backgroundColor = '';
                phoneField.style.backgroundColor = '';
                emailField.style.backgroundColor = '';
                addressField.style.backgroundColor = '';

                console.log('å·²æ¸…ç©ºæ¬„ä½ä¸¦è§£é™¤é–å®š');
            }
        }

        // æ›´æ–°æœƒå“¡é»æ•¸é¡¯ç¤º
        async function updateMemberPoints() {
            try {
                const response = await fetch('http://localhost:8080/customers/points', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const pointsData = await response.json();
                    memberPoints = pointsData.points || 0;

                    console.log('âœ… æœƒå“¡é»æ•¸è¼‰å…¥æˆåŠŸ:', memberPoints);

                    // æ›´æ–°é»æ•¸é¡¯ç¤º
                    const availablePointsSpan = document.getElementById('availablePoints');
                    const pointsInput = document.getElementById('points');
                    const pointsLabel = document.querySelector('label[for="points"]');

                    if (availablePointsSpan) {
                        availablePointsSpan.textContent = memberPoints;
                    }

                    if (pointsInput) {
                        pointsInput.max = memberPoints;
                        pointsInput.value = '0';

                        if (memberPoints > 0) {
                            pointsInput.disabled = false;
                            pointsInput.placeholder = `å¯ä½¿ç”¨ 0-${memberPoints} é»`;
                        } else {
                            pointsInput.disabled = true;
                            pointsInput.placeholder = 'ç„¡å¯ç”¨é»æ•¸';
                        }
                    }

                    if (pointsLabel && memberPoints <= 0) {
                        pointsLabel.innerHTML = 'ä½¿ç”¨é»æ•¸ <small class="text-muted">(ç„¡å¯ç”¨é»æ•¸)</small>';
                    }

                } else {
                    console.log('ğŸ” ç„¡æ³•è¼‰å…¥æœƒå“¡é»æ•¸ï¼Œå¯èƒ½æœªç™»å…¥');
                    memberPoints = 0;

                    // è¨­ç‚ºæœªç™»å…¥ç‹€æ…‹
                    const availablePointsSpan = document.getElementById('availablePoints');
                    const pointsInput = document.getElementById('points');
                    const pointsLabel = document.querySelector('label[for="points"]');

                    if (availablePointsSpan) {
                        availablePointsSpan.textContent = '0';
                    }

                    if (pointsInput) {
                        pointsInput.disabled = true;
                        pointsInput.value = '0';
                        pointsInput.placeholder = 'è«‹å…ˆç™»å…¥';
                    }

                    if (pointsLabel) {
                        pointsLabel.innerHTML = 'ä½¿ç”¨é»æ•¸ <small class="text-muted">(è«‹å…ˆç™»å…¥)</small>';
                    }
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥æœƒå“¡é»æ•¸å¤±æ•—:', error);
                memberPoints = 0;

                // è¨­ç‚ºéŒ¯èª¤ç‹€æ…‹
                const availablePointsSpan = document.getElementById('availablePoints');
                const pointsInput = document.getElementById('points');

                if (availablePointsSpan) {
                    availablePointsSpan.textContent = '0';
                }

                if (pointsInput) {
                    pointsInput.disabled = true;
                    pointsInput.value = '0';
                    pointsInput.placeholder = 'è¼‰å…¥å¤±æ•—';
                }
            }
        }

        // æ¸²æŸ“çµå¸³æ˜ç´°
        async function renderOrderItems(cart) {
            const orderItems = document.getElementById('orderItems');
            orderItems.innerHTML = '';
            let subtotal = 0;
            const updatedCart = await syncCartWithDatabase(cart);
            updatedCart.forEach((item, idx) => {
                const imgSrc = item.image && item.image.trim() !== '' ? item.image : 'https://via.placeholder.com/80x80?text=No+Image';
                const row = document.createElement('tr');
                row.innerHTML = `
            <td><img src="${imgSrc}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;" onerror="this.src='../images/baby.jpg';"></td>
            <td>${item.name}</td>
            <td>NT$${item.price}</td>
            <td>${item.quantity}</td>
            <td>NT$${item.price * item.quantity}</td>
            <td><button onclick="removeOrderItem(${idx})" class="btn btn-danger">åˆªé™¤</button></td>
        `;
                orderItems.appendChild(row);
                subtotal += item.price * item.quantity;
                updatePlusMinusBtnState(row, item.quantity, stockMap[item.id]);
            });
            localStorage.setItem('cart', JSON.stringify(updatedCart));
            document.getElementById('orderSubtotal').textContent = subtotal;
            document.getElementById('orderTotal').textContent = subtotal;
            document.getElementById('shippingFee').textContent = 0;
            document.getElementById('discount').textContent = 0;
            updateTotal();
        }

        // å·²ç§»é™¤çµå¸³æ˜ç´°çš„æ•¸é‡èª¿æ•´åŠŸèƒ½ï¼Œåƒ…åœ¨è³¼ç‰©è»Šéšæ®µå¯èª¿æ•´

        // çµå¸³æ˜ç´°åˆªé™¤
        async function removeOrderItem(idx) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                await renderOrderItems(cart);
                updateTotal();
            }
        }

        // éš±è—çµå¸³è¡¨å–®
        function hideCheckoutForm() {
            document.getElementById('cartContent').style.display = 'block';
            document.getElementById('checkoutForm').style.display = 'none';
        }

        // å®¢æˆ¶è³‡è¨Šè®Šæ›´æ™‚çš„è™•ç†å‡½æ•¸ï¼ˆå·²ç™»å…¥æœƒå“¡ä¸éœ€è¦æ­¤åŠŸèƒ½ï¼‰
        function onCustomerInfoChange() {
            // æœƒå“¡ç™»å…¥å¾Œï¼Œé»æ•¸æœƒåœ¨é€²å…¥çµå¸³é é¢æ™‚è‡ªå‹•è¼‰å…¥
            // ä¸éœ€è¦æ ¹æ“šè¡¨å–®è¼¸å…¥é‡æ–°æŸ¥è©¢
            console.log('ğŸ”„ å®¢æˆ¶è³‡è¨Šè®Šæ›´ï¼ˆæœƒå“¡é»æ•¸å·²åœ¨ç™»å…¥æ™‚è¼‰å…¥ï¼‰');
        }

        // é»æ•¸è¼¸å…¥é©—è­‰å’Œæ›´æ–°
        function validateAndUpdatePoints() {
            const pointsInput = document.getElementById('points');
            const availablePointsSpan = document.getElementById('availablePoints');
            const pointsError = document.getElementById('pointsError');

            if (!pointsInput || !availablePointsSpan) return;

            const inputPoints = parseInt(pointsInput.value) || 0;
            const availablePoints = parseInt(availablePointsSpan.textContent) || 0;

            // éš±è—éŒ¯èª¤è¨Šæ¯
            if (pointsError) {
                pointsError.style.display = 'none';
            }

            // é©—è­‰é»æ•¸
            if (inputPoints < 0) {
                pointsInput.value = '0';
                if (pointsError) {
                    pointsError.textContent = 'é»æ•¸ä¸èƒ½ç‚ºè² æ•¸';
                    pointsError.style.display = 'block';
                }
            } else if (inputPoints > availablePoints) {
                pointsInput.value = availablePoints.toString();
                if (pointsError) {
                    pointsError.textContent = `æœ€å¤šåªèƒ½ä½¿ç”¨ ${availablePoints} é»`;
                    pointsError.style.display = 'block';
                }
            }

            // æ›´æ–°ç¸½é¡
            updateTotal();
        }

        // æäº¤è¨‚å–®
        async function submitOrder(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            try {
                // æª¢æŸ¥è³¼ç‰©è»Šæ˜¯å¦ç‚ºç©º
                if (cart.length === 0) {
                    throw new Error('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼');
                }

                // ç²å–ä½¿ç”¨çš„é»æ•¸
                const pointsUsed = parseInt(document.getElementById('points').value) || 0;

                // ç›´æ¥å¾DOMå…ƒç´ ç²å–å€¼ï¼ˆé¿å…ç¦ç”¨æ¬„ä½å•é¡Œï¼‰
                const name = document.getElementById('recipientName').value.trim();
                const phone = document.getElementById('recipientPhone').value.trim();
                const email = document.getElementById('recipientEmail').value.trim();
                const address = document.getElementById('recipientAddress').value.trim();
                const paymentMethod = formData.get('paymentMethod');

                // å‰ç«¯é©—è­‰
                if (!name || !phone || !email || !address || !paymentMethod) {
                    throw new Error('è«‹å¡«å¯«å®Œæ•´çš„æ”¶ä»¶äººè³‡è¨Šå’Œä»˜æ¬¾æ–¹å¼');
                }

                // æº–å‚™è¨‚å–®æ•¸æ“š
                const orderData = {
                    name: name,
                    phone: phone,
                    email: email,
                    address: address,
                    paymentMethod: paymentMethod,
                    pointsUsed: pointsUsed,
                    totalAmount: parseFloat(document.getElementById('orderTotal').textContent.replace(/[^0-9.-]+/g, '')),
                    items: cart.map(item => {
                        // ç¢ºä¿æ¯å€‹å•†å“éƒ½æœ‰å¿…è¦çš„æ¬„ä½
                        if (!item.id && item.id !== 0) {
                            console.error('Missing product ID for item:', item);
                            throw new Error(`å•†å“ "${item.name}" ç¼ºå°‘å•†å“IDï¼Œè«‹é‡æ–°æ·»åŠ å•†å“åˆ°è³¼ç‰©è»Š`);
                        }
                        return {
                            productId: item.id,
                            name: item.name,
                            quantity: parseInt(item.quantity),
                            price: parseFloat(item.price)
                        };
                    })
                };

                console.log('ğŸ“ è¨‚å–®æ•¸æ“š:', orderData);

                // å¦‚æœé¸æ“‡ LINE Payï¼Œå‰‡å°å‘ LINE Pay æµç¨‹
                if (paymentMethod === 'linepay') {
                    await processLinePayPayment(orderData, cart);
                    return;
                }

                if (paymentMethod === 'ecpay') {
                    await processEcpayPayment(orderData);
                    return;
                }


                // å…¶ä»–ä»˜æ¬¾æ–¹å¼ï¼šç™¼é€è«‹æ±‚åˆ°å¾Œç«¯ - ä½¿ç”¨åŸæœ¬çš„APIè·¯å¾‘
                const response = await fetch('http://localhost:8080/orders/api/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                console.log('ğŸ” ä¼ºæœå™¨éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                console.log('ğŸ” éŸ¿æ‡‰ Content-Type:', response.headers.get('content-type'));

                if (!response.ok) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºJSONéŸ¿æ‡‰
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'è¨‚å–®å»ºç«‹å¤±æ•—');
                    } else {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTMLéŒ¯èª¤é é¢
                        const errorText = await response.text();
                        console.error('ä¼ºæœå™¨å›æ‡‰éJSONæ ¼å¼:', errorText.substring(0, 200));
                        throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ (${response.status}): APIç«¯é»å¯èƒ½ä¸å­˜åœ¨æˆ–é…ç½®éŒ¯èª¤`);
                    }
                }

                const result = await response.json();

                // æ¸…ç©ºè³¼ç‰©è»Š
                localStorage.setItem('cart', JSON.stringify([]));

                // æ§‹å»ºæˆåŠŸè¨Šæ¯
                let successMessage = `è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼\nè¨‚å–®ç·¨è™Ÿï¼š${result.orderId}`;
                if (result.pointsUsed && result.pointsUsed > 0) {
                    successMessage += `\nä½¿ç”¨é»æ•¸ï¼š${result.pointsUsed} é»`;
                }
                if (result.pointsEarned && result.pointsEarned > 0) {
                    successMessage += `\nç²å¾—é»æ•¸ï¼š${result.pointsEarned} é»`;
                }
                if (result.remainingPoints !== undefined) {
                    successMessage += `\nå‰©é¤˜é»æ•¸ï¼š${result.remainingPoints} é»`;
                }

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                alert(successMessage);

                // é‡å®šå‘åˆ°è¨‚å–®ç¢ºèªé é¢
                window.location.href = 'order-confirmation.html?orderId=' + result.orderId;

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'è¨‚å–®å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        async function processEcpayPayment(orderData) {
            try {
                console.log('ğŸŸ¢ æº–å‚™å°å‘ç¶ ç•Œä»˜æ¬¾...');

                const response = await fetch('http://localhost:8080/ecpay/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        orderNumber: 'ORDER_' + Date.now(), // æˆ– orderData.orderId
                        amount: Math.round(orderData.totalAmount),
                        item: 'PikaBaby è³¼ç‰©å•†å“'
                    })
                });

                const html = await response.text();

                // é–‹æ–°è¦–çª—é€å‡ºä»˜æ¬¾è¡¨å–®
                const win = window.open('', '_blank');
                win.document.open();
                win.document.write(html);
                win.document.close();

                // å¯é¸ï¼šå°‡è¨‚å–®å„²å­˜èµ·ä¾†ä¾› callback ä½¿ç”¨
                localStorage.setItem('pendingOrder', JSON.stringify(orderData));

            } catch (error) {
                console.error('âŒ ç¶ ç•Œä»˜æ¬¾éŒ¯èª¤:', error);
                alert('ç¶ ç•Œä»˜æ¬¾åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
            }
        }


        // LINE Pay ä»˜æ¬¾è™•ç†å‡½æ•¸
        async function processLinePayPayment(orderData, cart) {
            try {
                console.log('ğŸ”„ æº–å‚™ LINE Pay ä»˜æ¬¾...');

                // ç”Ÿæˆå”¯ä¸€è¨‚å–®ID
                const orderId = 'ORDER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // æº–å‚™ LINE Pay è«‹æ±‚æ•¸æ“š
                const linePayRequest = {
                    amount: Math.round(orderData.totalAmount), // LINE Pay éœ€è¦æ•´æ•¸é‡‘é¡
                    currency: 'TWD',
                    orderId: orderId,
                    packages: [{
                        id: 'PACKAGE_1',
                        amount: Math.round(orderData.totalAmount),
                        name: 'PikaBaby è³¼ç‰©',
                        products: cart.map((item, index) => ({
                            id: item.id.toString(),
                            name: item.name,
                            quantity: item.quantity,
                            price: index == 0? Math.round(item.price) - orderData.pointsUsed : Math.round(item.price)
                        }))
                    }],
                    redirectUrls: {
                        confirmUrl: `${window.location.origin}/Shopping/linepay-confirm.html?orderId=${orderId}`,
                        cancelUrl: `${window.location.origin}/Shopping/shoppingcart.html?linepay=cancelled`
                    }
                };

                console.log('ğŸ“ LINE Pay è«‹æ±‚æ•¸æ“š:', linePayRequest);

                // æš«å­˜è¨‚å–®è³‡æ–™åˆ° localStorageï¼ˆç”¨æ–¼ä»˜æ¬¾ç¢ºèªå¾Œå»ºç«‹æ­£å¼è¨‚å–®ï¼‰
                localStorage.setItem('pendingOrder', JSON.stringify({
                    ...orderData,
                    orderId: orderId,
                    cart: cart
                }));

                // ç™¼é€ LINE Pay è«‹æ±‚
                const response = await fetch('http://localhost:8080/linepay/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(linePayRequest)
                });

                if (!response.ok) {
                    throw new Error('LINE Pay è«‹æ±‚å¤±æ•—');
                }

                const result = await response.json();
                console.log('âœ… LINE Pay éŸ¿æ‡‰:', result);

                if (result.returnCode === '0000' && result.info && result.info.paymentUrl) {
                    // æˆåŠŸå»ºç«‹ LINE Pay ä»˜æ¬¾è«‹æ±‚ï¼Œå°å‘ä»˜æ¬¾é é¢
                    console.log('ğŸ”„ å°å‘ LINE Pay ä»˜æ¬¾é é¢...');
                    window.location.href = result.info.paymentUrl.web;
                } else {
                    throw new Error('LINE Pay åˆå§‹åŒ–å¤±æ•—: ' + (result.returnMessage || 'æœªçŸ¥éŒ¯èª¤'));
                }

            } catch (error) {
                console.error('âŒ LINE Pay ä»˜æ¬¾è™•ç†å¤±æ•—:', error);
                alert('LINE Pay ä»˜æ¬¾è™•ç†å¤±æ•—ï¼š' + error.message);
            }
        }

        function updateTotal() {
            const subtotal = parseFloat(document.getElementById('orderSubtotal').textContent);
            const shippingFee = parseFloat(document.getElementById('shippingFee').textContent);
            const discountElem = document.getElementById('discount');
            const discount = discountElem ? parseFloat(discountElem.textContent) : 0;
            const points = parseInt(document.getElementById('points').value) || 0;
            const total = subtotal + shippingFee - discount - points;
            document.getElementById('orderTotal').textContent = total;
        }

        // åŠ è³¼å•†å“åŠ å…¥è³¼ç‰©è»Šï¼ˆçµå¸³é å°ˆç”¨ï¼‰
        async function addAddonToCart(productName, price, imageUrl, btn, productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const idx = cart.findIndex(item => item.name === productName);
            if (idx > -1) {
                cart[idx].quantity += 1;
            } else {
                if (!productId) {
                    alert('ç„¡æ³•åŠ å…¥å•†å“ï¼šç¼ºå°‘å•†å“ID');
                    return;
                }
                cart.push({
                    id: productId,
                    name: productName,
                    price: price,
                    quantity: 1,
                    image: imageUrl
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            alert(`å·²å°‡ ${productName} åŠ å…¥è³¼ç‰©è»Šï¼`);
            await loadCart();
            await renderOrderItems(cart);
            updateTotal();
            // æŒ‰éˆ•è®Šæˆå·²åŠ å…¥ä¸”ä¸èƒ½å†é»
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'å·²åŠ å…¥è³¼ç‰©è»Š';
            }
        }

        // ç¯©é¸åŠŸèƒ½
        function filterProducts(category) {
            // æ›´æ–° URL åƒæ•¸
            const url = new URL(window.location.href);
            url.searchParams.set('category', category);
            window.history.pushState({}, '', url);

            // å¦‚æœç•¶å‰é é¢ä¸æ˜¯å•†å“é é¢ï¼Œå‰‡è·³è½‰åˆ°å•†å“é é¢
            if (!window.location.pathname.includes('product.html')) {
                window.location.href = `product.html?category=${category}`;
            }
        }

        // updateQuantityèˆ‡onQuantityInputéƒ½è¦å³æ™‚æ›´æ–°åŠ æ¸›è™Ÿdisabledç‹€æ…‹
        async function updateQuantity(idx, delta) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart[idx];
            const stock = stockMap[item.id] || 99; // ç›´æ¥ç”¨å…¨åŸŸ stockMap
            let currentQuantity = item.quantity;
            let newQuantity = currentQuantity + delta;
            if (currentQuantity >= stock && delta > 0) {
                newQuantity = stock;
            }
            if (currentQuantity <= 1 && delta < 0) {
                newQuantity = 1;
            }
            newQuantity = Math.min(Math.max(newQuantity, 1), stock);
            cart[idx].quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            // åªæ›´æ–°è©²è¡Œ
            const cartTable = document.getElementById('cart-table');
            const row = cartTable.rows[idx + 1];
            const qtyDisplay = document.getElementById(`qty-display-${idx}`);
            if (row && qtyDisplay) {
                qtyDisplay.textContent = newQuantity;
                row.cells[4].textContent = `NT$${cart[idx].price * cart[idx].quantity}`;
                updatePlusMinusBtnState(row, newQuantity, stock);
            }
            // æ›´æ–°ç¸½è¨ˆ
            let total = 0;
            cart.forEach(item => { total += item.price * item.quantity; });
            document.getElementById('cart-total').textContent = `ç¸½è¨ˆï¼šNT$ ${total}`;
        }

        // çµ±ä¸€æ§åˆ¶åŠ æ¸›æŒ‰éˆ•ç‹€æ…‹
        function updatePlusMinusBtnState(row, newQuantity, stock) {
            const minusBtn = row.cells[3].querySelector('button:nth-child(1)');
            const plusBtn = row.cells[3].querySelector('button:nth-child(3)');
            if (minusBtn) minusBtn.disabled = newQuantity <= 1;
            if (plusBtn) plusBtn.disabled = newQuantity >= stock;
        }

        // æ–°å¢ç¹¼çºŒè³¼ç‰©åŠŸèƒ½
        function continueShopping() {
            window.location.href = '../Products/product.html';
        }
    </script>
</body>

</html>