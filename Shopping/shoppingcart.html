<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ë≥ºÁâ©Ëªä - PikaBaby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/nav.css">
    <style>
        /* Ë≥ºÁâ©ËªäÊ®£Âºè */
        .cart-container {
            max-width: 1500px;
            margin: 20px auto;
            padding: 20px;
        }

        .cart-table {
            width: 100%;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .cart-table th,
        .cart-table td {
            padding: 18px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #ddd;
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        .cart-item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-info {
            text-align: left;
        }

        .product-name {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .product-specs {
            font-size: 0.9em;
            color: #666;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .quantity-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }

        .quantity-display {
            padding: 5px 15px;
            border: 1px solid #ddd;
            min-width: 50px;
            text-align: center;
        }

        .checkout-form-wrapper {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
            box-sizing: border-box;
        }

        .checkout-form {
            display: block;
            max-width: 1200px;
            margin: 40px auto;
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0 32px;
            text-align: center;
        }

        #checkoutForm>* {
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .order-summary,
        .checkout-addons,
        #orderForm {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        #orderForm {
            margin-left: auto;
            margin-right: auto;
        }

        .order-summary {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            background: white;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 20px;
            padding: 20px 0;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .order-item-image {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }

        .order-item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .order-item-details {
            flex-grow: 1;
        }

        .order-item-price {
            text-align: right;
            min-width: 100px;
        }

        .total-section {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .checkout-addons {
            width: 100%;
            margin: 30px 0 0 0;
            background: #fffbe6;
            border-radius: 8px;
            padding: 20px 10px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            text-align: center;
        }

        .checkout-addons-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .checkout-addon-list {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .checkout-addon-item {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            padding: 12px 16px;
            width: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .checkout-addon-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .checkout-addon-item button {
            margin-top: 8px;
        }

        .checkout-addon-item button:disabled {
            background: #ccc !important;
            border-color: #ccc !important;
            cursor: not-allowed;
        }

        .cart-main-row {
            display: flex;
            align-items: flex-start;
            gap: 40px;
        }

        #cartContent {
            flex: 1 1 0%;
        }

        .recommendations {
            flex: 0 0 300px;
            min-width: 250px;
            margin-left: auto;
            text-align: right;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        @media (max-width: 900px) {
            .cart-main-row {
                flex-direction: column;
            }

            .recommendations {
                margin-left: 0;
                text-align: center;
            }
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .cart-table tfoot td {
            border-bottom: none !important;
        }

        .cart-action-row {
            margin-top: 0;
            margin-bottom: 20px;
            /* ÂèØ‰æùÈúÄÊ±ÇË™øÊï¥ */
        }

        @media (max-width: 991.98px) {
            .navbar-collapse.show {
                background-color: #f5e6c8 !important;
                border-radius: 0 0 12px 12px;
            }

            .navbar-collapse .mobile-logo {
                display: none;
            }

            .navbar-collapse.show .mobile-logo {
                display: block !important;
            }
        }

        @media (min-width: 992px) {
            .mobile-logo {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <!-- ÁΩÆÈ†ÇÁöÑ‰øÉÈä∑Ë®äÊÅØ -->
        <div class="top-banner">
            ÊØèÈÄ±‰∫îÂÖ≠Êó•üî•Êñ∞‰∫∫‰ª£ÁêÜÂØÑË≥£ÂÖçÈÅã
            <font color="red"><span></span> Êó• <span></span> ÊôÇ <span></span> ÂàÜ <span></span> Áßí</font>
            <div style="display: inline-block; background-color: black; color: white">
                Ispian love you
            </div>
        </div>

        <!-- LOGO -->
        <div class="nav-logo-row">
            <img src="../images/logo-pikababy.png" alt="PikaBaby" class="nav-logo" />
        </div>
    </header>

    <!-- Â∞éË¶ΩÂàó -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- <div class="collapse navbar-collapse justify-content-center d-flex" id="navbarSupportedContent"> -->
            <div class="collapse navbar-collapse justify-content-around d-flex" id="navbarSupportedContent">
                <!-- LOGO -->
                <img id="logo" src="../images/logo-pikababy.png" alt="PikaBaby"
                    style="height: 80px; width: 0px; transition: 3s; display: none;" />
                <ul class="navbar-nav ml-auto nav-links gap-5 me-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../index.html">È¶ñÈ†Å</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown1" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Âπ¥ÈΩ°ÂçÄÈñì(0-3M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown1">
                            <a class="dropdown-item" href="../Products/product.html?category=14">Â•∂Áì∂/Â•∂Âò¥</a>
                            <a class="dropdown-item" href="../Products/product.html?category=15">ÂúçÂÖú/ÊèπÂ∑æ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=1">Â¨∞ÂÖíÊúçË£ù</a>
                            <a class="dropdown-item" href="../Products/product.html?category=16">Ê∏ÖÊΩîÁî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">Â¨∞ÂÖíÊé®Ëªä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">Â¨∞ÂÖíÂ∫ä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=17">Âì∫‰π≥Áî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">Â¨∞ÂÖíÁî®ÂìÅ</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown2" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Âπ¥ÈΩ°ÂçÄÈñì(3-6M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown2">
                            <a class="dropdown-item" href="../Products/product.html?category=1">Â¨∞ÂÖíÊúçË£ù</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">Áé©ÂÖ∑</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">Â¨∞ÂÖíÊé®Ëªä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=3">Â¨∞ÂÖíÂ∫ä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">Ê±ΩÂ∫ß</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">Â¨∞ÂÖíÁî®ÂìÅ</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown3" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Âπ¥ÈΩ°ÂçÄÈñì(6-12M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown3">
                            <a class="dropdown-item" href="../Products/product.html?category=7">Â≠∏Ê≠•Áî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=18">È§êÂÖ∑Áî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=8">ÂπºÂÖíÊúçË£ù</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">Áé©ÂÖ∑</a>
                            <a class="dropdown-item" href="../Products/product.html?category=2">Â¨∞ÂÖíÊé®Ëªä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=6">Ê±ΩÂ∫ß</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">Â¨∞ÂÖíÁî®ÂìÅ</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown4" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            Âπ¥ÈΩ°ÂçÄÈñì(2-3y)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown4">
                            <a class="dropdown-item" href="../Products/product.html?category=9">ÂπºÊïôÁî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=10">ÂÖíÁ´•ÊúçË£ù</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">Áé©ÂÖ∑</a>
                            <a class="dropdown-item" href="../Products/product.html?category=5">Ê±ΩÂ∫ß</a>
                            <a class="dropdown-item" href="../Products/product.html?category=11">ÂÖíÁ´•Êé®Ëªä</a>
                            <a class="dropdown-item" href="../Products/product.html?category=12">È§êÊ§Ö</a>
                            <a class="dropdown-item" href="../Products/product.html?category=13">ÈõªÂô®Áî®ÂìÅ</a>
                            <a class="dropdown-item" href="../Products/product.html?category=4">Â¨∞ÂÖíÁî®ÂìÅ</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            ‰∫åÊâãË®óÂîÆ
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center gap-5" aria-labelledby="navbarDropdown5">
                            <a class="dropdown-item" href="../Secondhand/consign.html">Ë®óÂîÆÊúçÂãô</a>
                            <a class="dropdown-item" href="../Secondhand/consign_apply.html">‰∫åÊâãË®óÂîÆÁî≥Ë´ã</a>
                            <a class="dropdown-item" href="../Secondhand/consign_search.html">Ë®óÂîÆÁ¥ÄÈåÑÊü•Ë©¢</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_apply.html">Ë®óÂîÆÊèêÊ¨æÁî≥Ë´ã</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_search.html">ÊèêÊ¨æÁ¥ÄÈåÑÊü•Ë©¢</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../about.html">ÈóúÊñºÊàëÂÄë</a>
                    </li>
                    <div class="d-flex gap-3">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="../Shopping/shoppingcart.html">
                                <img src="../images/cart.png" style="width: 30px;">
                            </a>
                            <!-- <div class="dropdown-menu p-3 justify-content-center gap-5"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="Shopping/shoppingcart.html">Ë≥ºÁâ©Ëªä</a>
                                <a class="dropdown-item" href="Shopping/order.html">Ë®ÇÂñÆÊü•Ë©¢</a>
                            </div> -->
                        </li>
                        <!-- ‚úÖ Êú™ÁôªÂÖ•ÊôÇÔºöË∑≥ loginÔºå‰∏çÈ°ØÁ§∫ dropdown -->
                        <li class="nav-item" id="loginNavItem">
                            <a class="nav-link" href="../Member/login.html">
                                <img src="../images/user.png" style="width: 30px;" alt="ÊúÉÂì°ÁôªÂÖ•ÂúñÁ§∫">
                            </a>
                        </li>
                        <!-- ‚úÖ Â∑≤ÁôªÂÖ•ÊôÇÔºöÊ≠£Â∏∏ dropdown -->
                        <li class="nav-item dropdown" id="memberDropdownItem" style="display: none;">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img src="../images/user.png" style="width: 30px;" alt="ÊúÉÂì°ÂúñÁ§∫">
                            </a>
                            <div class="dropdown-menu p-3 justify-content-center gap-5" id="dropdownForUser"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="../Member/member.html">ÊúÉÂì°‰∏≠ÂøÉ</a>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">ÁôªÂá∫</a>
                            </div>
                        </li>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
    <main style="background: #fff; padding: 20px 0; min-height: fit-content;">
        <div class="cart-container">
            <div class="cart-main-row">
                <!-- Ë≥ºÁâ©ËªäÂÖßÂÆπ -->
                <div id="cartContent">
                    <h2 style="color: rgb(95, 76, 0); text-align: center;">Ë≥ºÁâ©Ëªä</h2>
                    <table class="cart-table" id="cart-table">
                        <thead>
                            <tr>
                                <th>ÂïÜÂìÅÂúñÁâá</th>
                                <th>ÂïÜÂìÅÂêçÁ®±</th>
                                <th>ÂñÆÂÉπ</th>
                                <th>Êï∏Èáè</th>
                                <th>Â∞èË®à</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4"></td>
                                <td style="font-size: 1.2em; font-weight: bold; border-bottom: none;" id="cart-total">
                                    Á∏ΩË®àÔºöNT$ 0</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="6" style="padding-top: 0; border-bottom: none;">
                                    <div class="d-flex justify-content-end align-items-center gap-2 cart-action-row">
                                        <button class="btn btn-success" onclick="continueShopping()">ÁπºÁ∫åË≥ºÁâ©</button>
                                        <button class="btn btn-primary" onclick="checkLoginAndProceed()">ÂâçÂæÄÁµêÂ∏≥</button>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <!-- ÁµêÂ∏≥Ë°®ÂñÆÁßªÂá∫ cart-main-rowÔºåÁõ¥Êé•ÊîæÂú® cart-container ‰∏ãÊñπ -->
            <div id="checkoutForm" style="display: none;">
                <h2 style="color: rgb(95, 76, 0); text-align: center;">ÁµêÂ∏≥Ë≥áË®ä</h2>
                <!-- Ë®ÇÂñÆÊëòË¶Å -->
                <div class="order-summary">
                    <table class="cart-table" id="checkout-table">
                        <thead>
                            <tr>
                                <th><img src="../images/pikababy.png" alt="ÂïÜÂìÅÂúñÁâá" style="height:32px;"></th>
                                <th>ÂïÜÂìÅÂêçÁ®±</th>
                                <th>ÂñÆÂÉπ</th>
                                <th>Êï∏Èáè</th>
                                <th>Â∞èË®à</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="orderItems"></tbody>
                    </table>
                    <div class="total-section">
                        <div class="mb-2">ÂïÜÂìÅÁ∏ΩÈ°çÔºö<span id="orderSubtotal">0</span> ÂÖÉ</div>
                        <div class="mb-2">ÈÅãË≤ªÔºö<span id="shippingFee">0</span> ÂÖÉ</div>
                        <div class="mb-2">ÂÑ™ÊÉ†ÊäòÊâ£Ôºö<span id="discount">0</span> ÂÖÉ</div>
                        <div class="mb-2">
                            <label for="points">‰ΩøÁî®ÊúÉÂì°ÈªûÊï∏ÊäòÂÉπ (1ÈªûÊäò1ÂÖÉ)Ôºö</label>
                            <input type="number" id="points" min="0" value="0" onchange="validateAndUpdatePoints()"
                                style="width: 80px;"><br>
                            <span style="margin-left:8px;color:#e6b800;">Ââ©È§òÈªûÊï∏Ôºö<span id="availablePoints">ËºâÂÖ•‰∏≠...</span>
                                Èªû</span>
                            <div id="pointsError" style="color: red; font-size: 12px; margin-top: 4px; display: none;">
                            </div>
                        </div>
                        <div class="h5">Êáâ‰ªòÁ∏ΩÈ°çÔºö<span id="orderTotal">0</span> ÂÖÉ</div>
                    </div>
                </div>

                <!-- Âä†Ë≥ºÂïÜÂìÅÈÅ∏È†Ö -->
                <div class="checkout-addons">
                    <div class="checkout-addons-title">Âä†Ë≥ºÂïÜÂìÅÊé®Ëñ¶</div>
                    <div class="checkout-addon-list">
                        <div class="checkout-addon-item">
                            <img src="../images/product1.jpg" alt="Âä†Ë≥ºÂïÜÂìÅA">
                            <div>Âä†Ë≥ºÂïÜÂìÅA</div>
                            <div>NT$ 99</div>
                            <button class="btn btn-sm btn-primary" id="addonA-btn"
                                onclick="addAddonToCart('Âä†Ë≥ºÂïÜÂìÅA', 99, '../images/product1.jpg', this, 1)">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
                        </div>
                        <div class="checkout-addon-item">
                            <img src="../images/product2.jpg" alt="Âä†Ë≥ºÂïÜÂìÅB">
                            <div>Âä†Ë≥ºÂïÜÂìÅB</div>
                            <div>NT$ 150</div>
                            <button class="btn btn-sm btn-primary" id="addonB-btn"
                                onclick="addAddonToCart('Âä†Ë≥ºÂïÜÂìÅB', 150, '../images/product2.jpg', this, 2)">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
                        </div>
                    </div>
                </div>

                <!-- Êî∂‰ª∂Ë≥áË®äË°®ÂñÆ -->
                <form id="orderForm" onsubmit="submitOrder(event)" style="width:100%;max-width:600px;margin:0 auto;">
                    <!-- ÊúÉÂì°Ë≥áÊñôËá™ÂãïÂ∏∂ÂÖ•ÈÅ∏È†Ö -->
                    <div class="mb-4 p-3"
                        style="background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 32px;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useMemberData"
                                onchange="toggleMemberData()">
                            <label class="form-check-label fw-bold" for="useMemberData" style="color: #0d6efd;">
                                ‰ΩøÁî®ÊúÉÂì°Ë≥áÊñô‰ΩúÁÇ∫Êî∂‰ª∂‰∫∫Ë≥áË®ä
                            </label>
                        </div>
                        <small class="text-muted">ÂãæÈÅ∏Ê≠§ÈÅ∏È†ÖÂ∞áËá™ÂãïÂ∏∂ÂÖ•ÊÇ®ÁöÑÊúÉÂì°Ë≥áÊñôÔºå‰∏¶ÈéñÂÆöÊî∂‰ª∂‰∫∫Ê¨Ñ‰Ωç</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Êî∂‰ª∂‰∫∫ÂßìÂêç</label>
                        <input type="text" class="form-control" name="name" id="recipientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ËÅØÁµ°ÈõªË©±</label>
                        <input type="tel" class="form-control" name="phone" id="recipientPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="recipientEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Êî∂‰ª∂Âú∞ÂùÄ</label>
                        <input type="text" class="form-control" name="address" id="recipientAddress" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‰ªòÊ¨æÊñπÂºè</label>
                        <select class="form-select" name="paymentMethod" required>
                            <option value="">Ë´ãÈÅ∏Êìá‰ªòÊ¨æÊñπÂºè</option>
                            <option value="ecpay">üí≥ ‰ø°Áî®Âç°</option>
                            <option value="transfer">üè¶ ÈäÄË°åËΩâÂ∏≥</option>
                            <option value="linepay">üíö LINE Pay</option>
                        </select>
                        <small class="text-muted">
                            ÈÅ∏Êìá LINE Pay Â∞áË∑≥ËΩâËá≥ LINE ÂÆòÊñπ‰ªòÊ¨æÈ†ÅÈù¢ÈÄ≤Ë°åÂÆâÂÖ®‰ªòÊ¨æ
                        </small>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="hideCheckoutForm()">ËøîÂõûË≥ºÁâ©Ëªä</button>
                        <button type="submit" class="btn btn-primary">Á¢∫Ë™çÈÄÅÂá∫</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- È†ÅÂ∞æ -->
    <footer>
        <div class="footer-container align-items-center">
            <div class="footer-section" style="flex: 0;">
                <img src="../images/logo-pikababy.png" alt="PikaBaby" class="footer-logo" />
            </div>
            <div class="footer-section w-100">
                <p class="footer-title">PikaBaby</p>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/index.html">HOME</a>
                </p>
                <p class="mb-1">
                    <a href="/about.html">ÈóúÊñºÊàëÂÄë</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>ÂìÅÁâåÊúçÂãô</h3>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/Products/product.html">Baby Store</a>
                </p>
                <p class="mb-1">
                    <a href="/Secondhand/consign.html">‰∫åÊâãË®óÂîÆ</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>ËÅØÁµ°ÊàëÂÄë</h3>
                <div class="footer-line"></div>
                <p class="mb-1">ËÅØÁµ°ÈõªË©±Ôºö(04) 2326-5860</p>
                <p class="mb-1">ËÅØÁµ°Âú∞ÂùÄÔºöÂè∞‰∏≠Â∏ÇÂçóÂ±ØÂçÄÂÖ¨ÁõäË∑Ø‰∫åÊÆµ51Ëôü18Ê®ì</p>
            </div>
        </div>
    </footer>

    <!-- Â•∂Áì∂ -->
    <div class="floating-bottle"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/navbar.js"></script>
    <script src="../js/logout.js"></script>
    <script src="../js/usernoToggle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            //Ëã•ÊúâÁôªÂÖ•ÊúÉÂì°Ôºå‰∏ãÊãâÈÅ∏ÂñÆÈ°ØÁ§∫
            $.ajax({
                method: "GET",
                url: "http://localhost:8080/customers/front/me",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    setUserToggle(data);
                },
                error: function () {
                    console.log("Êú™ÁôªÂÖ•");
                }
            })
        })

        let stockMap = {};
        let cartItems = [];

        // Ê™¢Êü•ÊúÉÂì°ÁôªÂÖ•ÁãÄÊÖã‰∏¶ÈÄ≤Ë°åÁµêÂ∏≥
        async function checkLoginAndProceed() {
            try {
                // Ê™¢Êü•ÊúÉÂì°ÁôªÂÖ•ÁãÄÊÖã
                const response = await fetch('http://localhost:8080/customers/check-login', {
                    method: 'GET',
                    credentials: 'include' // ÂåÖÂê´ Session cookie
                });

                if (response.ok) {
                    const loginStatus = await response.json();

                    if (loginStatus.isLoggedIn) {
                        // Â∑≤ÁôªÂÖ•ÔºåÁõ¥Êé•ÈÄ≤ÂÖ•ÁµêÂ∏≥ÊµÅÁ®ã
                        console.log('‚úÖ ÊúÉÂì°Â∑≤ÁôªÂÖ•ÔºåÈÄ≤ÂÖ•ÁµêÂ∏≥ÊµÅÁ®ã');
                        await showCheckoutForm();
                    } else {
                        // Êú™ÁôªÂÖ•ÔºåÊèêÁ§∫ÁôªÂÖ•
                        showLoginPrompt();
                    }
                } else {
                    // APIÈåØË™§ÔºåÊö´ÊôÇÂÖÅË®±ÁµêÂ∏≥ÔºàÂêë‰∏ãÂÖºÂÆπÔºâ
                    console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÊ™¢Êü•ÁôªÂÖ•ÁãÄÊÖãÔºåÂÖÅË®±ÁµêÂ∏≥');
                    await showCheckoutForm();
                }
            } catch (error) {
                console.error('‚ùå Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖãÂ§±Êïó:', error);
                // Á∂≤Ë∑ØÈåØË™§ÔºåÊö´ÊôÇÂÖÅË®±ÁµêÂ∏≥
                await showCheckoutForm();
            }
        }

        // È°ØÁ§∫ÁôªÂÖ•ÊèêÁ§∫
        function showLoginPrompt() {
            const loginConfirm = confirm(
                'Ë´ãÂÖàÁôªÂÖ•ÊúÉÂì°ÊâçËÉΩÈÄ≤Ë°åÁµêÂ∏≥ÔºÅ\n\n' +
                'ÈªûÊìä„ÄåÁ¢∫ÂÆö„ÄçÂâçÂæÄÁôªÂÖ•È†ÅÈù¢\n' +
                'ÈªûÊìä„ÄåÂèñÊ∂à„ÄçÁπºÁ∫åÁÄèË¶ΩÂïÜÂìÅ'
            );

            if (loginConfirm) {
                // ÂÑ≤Â≠òÁï∂ÂâçÈ†ÅÈù¢Âà∞ÁôªÂÖ•ÂæåËøîÂõû
                sessionStorage.setItem('returnToCheckout', 'true');
                window.location.href = '../Member/login.html';
            }
        }

        // Áï∂È†ÅÈù¢Âä†ËºâÊôÇÂü∑Ë°å
        document.addEventListener('DOMContentLoaded', async function () {
            await loadCart();

            // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÁõ¥Êé•È°ØÁ§∫ÁµêÂ∏≥Ë°®ÂñÆÔºàÂæûÁôªÂÖ•È†ÅÈù¢ËøîÂõûÔºâ
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('checkout') === 'true') {
                // Ê∏ÖÁêÜURLÂèÉÊï∏
                window.history.replaceState({}, document.title, window.location.pathname);
                // Âª∂ÈÅ≤‰∏ÄÈªûÂÜçÈ°ØÁ§∫ÁµêÂ∏≥Ë°®ÂñÆÔºåÁ¢∫‰øùÈ†ÅÈù¢Ê∏≤ÊüìÂÆåÊàê
                setTimeout(async () => {
                    await showCheckoutForm();
                }, 100);
            }

            // Ê™¢Êü• LINE Pay ÂèñÊ∂à‰ªòÊ¨æÁöÑÊÉÖÊ≥Å
            if (urlParams.get('linepay') === 'cancelled') {
                // ÊÅ¢Âæ©Ë≥ºÁâ©ËªäË≥áÊñô
                const pendingOrderData = localStorage.getItem('pendingOrder');
                if (pendingOrderData) {
                    const orderData = JSON.parse(pendingOrderData);
                    if (orderData.cart) {
                        localStorage.setItem('cart', JSON.stringify(orderData.cart));
                        await loadCart(); // ÈáçÊñ∞ËºâÂÖ•Ë≥ºÁâ©Ëªä
                    }
                }
                localStorage.removeItem('pendingOrder');

                // Ê∏ÖÁêÜURLÂèÉÊï∏‰∏¶È°ØÁ§∫ÊèêÁ§∫
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('LINE Pay ‰ªòÊ¨æÂ∑≤ÂèñÊ∂àÔºåÂïÜÂìÅÂ∑≤ÊÅ¢Âæ©Âà∞Ë≥ºÁâ©Ëªä‰∏≠„ÄÇ');
            }

            // ÊúÉÂì°ÈªûÊï∏Â∞áÂú®È°ØÁ§∫ÁµêÂ∏≥Ë°®ÂñÆÊôÇÂãïÊÖãËºâÂÖ•
            // Ê™¢Êü•Âä†Ë≥ºÂïÜÂìÅÊåâÈàïÁãÄÊÖã
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.find(item => item.name === 'Âä†Ë≥ºÂïÜÂìÅA')) {
                const btnA = document.getElementById('addonA-btn');
                if (btnA) { btnA.disabled = true; btnA.textContent = 'Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä'; }
            }
            if (cart.find(item => item.name === 'Âä†Ë≥ºÂïÜÂìÅB')) {
                const btnB = document.getElementById('addonB-btn');
                if (btnB) { btnB.disabled = true; btnB.textContent = 'Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä'; }
            }
        });

        // Âæû localStorage Âä†ËºâË≥ºÁâ©ËªäÊï∏Êìö‰∏¶ÂêåÊ≠•ÂïÜÂìÅË≥áË®ä
        async function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartContainer = document.getElementById('cart-items');
            cartContainer.innerHTML = '';
            let total = 0;
            // Êü•Ë©¢ÊâÄÊúâÂïÜÂìÅÂ∫´Â≠ò
            stockMap = {};
            await Promise.all(cart.map(async (item) => {
                try {
                    const response = await fetch(`http://localhost:8080/products/api/stock/${item.id}`);
                    if (response.ok) {
                        const stockData = await response.json();
                        stockMap[item.id] = stockData.stock || 0;
                    } else {
                        stockMap[item.id] = 99; // Êü•Ë©¢Â§±ÊïóÁµ¶Â§ßÂÄº
                    }
                } catch {
                    stockMap[item.id] = 99;
                }
            }));
            cart.forEach((item, idx) => {
                const imgSrc = item.image && item.image.trim() !== '' ? item.image : 'https://via.placeholder.com/80x80?text=No+Image';
                const disableMinus = item.quantity <= 1 ? 'disabled' : '';
                const disablePlus = item.quantity >= stockMap[item.id] ? 'disabled' : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${imgSrc}" alt="${item.name}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;" onerror="this.src='../images/baby.jpg';"></td>
                    <td>${item.name}</td>
                    <td>NT$${item.price}</td>
                    <td>
                        <div style="display:flex;align-items:center;justify-content:center;gap:4px;">
                            <button type="button" onclick="updateQuantity(${idx}, -1)" class="btn btn-sm btn-outline-secondary" ${disableMinus}>-</button>
                            <span id="qty-display-${idx}" style="display:inline-block;width:60px;text-align:center;line-height:32px;">${item.quantity}</span>
                            <button id="plus-btn-${idx}" type="button" onclick="updateQuantity(${idx}, 1)" class="btn btn-sm btn-outline-secondary" ${disablePlus}>+</button>
                        </div>
                        <div style='font-size:0.9em;color:#b8860b;margin-top:2px;'>Â∫´Â≠òÂÉÖÂâ©${stockMap[item.id]}‰ª∂</div>
                    </td>
                    <td>NT$${item.price * item.quantity}</td>
                    <td><button onclick="removeItem(${idx})"  class="btn btn-danger">Âà™Èô§</button></td>
                `;
                cartContainer.appendChild(row);
                total += item.price * item.quantity;
                updatePlusMinusBtnState(row, item.quantity, stockMap[item.id]);
            });
            document.getElementById('cart-total').textContent = `Á∏ΩË®àÔºöNT$ ${total}`;
        }

        // ÂêåÊ≠•Ë≥ºÁâ©ËªäÂïÜÂìÅË≥áË®äËàáË≥áÊñôÂ∫´
        async function syncCartWithDatabase(cart) {
            const updatedCart = [];

            for (const item of cart) {
                try {
                    // ÂæûÂæåÁ´ØÁç≤ÂèñÊúÄÊñ∞ÁöÑÂïÜÂìÅË≥áË®ä
                    const response = await fetch(`http://localhost:8080/products/front/detail/${item.id}`);

                    if (response.ok) {
                        const productData = await response.json();
                        if (productData.success) {
                            // Êõ¥Êñ∞ÂïÜÂìÅË≥áË®äÔºå‰øùÁïôË≥ºÁâ©Ëªä‰∏≠ÁöÑÊï∏Èáè
                            const updatedItem = {
                                id: item.id,
                                name: productData.name,
                                price: productData.price,
                                quantity: item.quantity,
                                image: productData.primaryImageUrl ?
                                    (productData.primaryImageUrl.startsWith('/products/front/images/') ?
                                        'http://localhost:8080' + productData.primaryImageUrl :
                                        productData.primaryImageUrl) :
                                    '../images/baby.jpg'
                            };
                            updatedCart.push(updatedItem);
                            console.log(`‚úÖ Â∑≤Êõ¥Êñ∞ÂïÜÂìÅË≥áË®ä: ${productData.name}`);
                        } else {
                            console.warn(`‚ö†Ô∏è ÂïÜÂìÅ ${item.name} (ID: ${item.id}) ÂèØËÉΩÂ∑≤‰∏ãÊû∂ÊàñÂ∫´Â≠ò‰∏çË∂≥Ôºå‰øùÁïôÂéüË≥áË®ä`);
                            updatedCart.push(item);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è ÁÑ°Ê≥ïÁç≤ÂèñÂïÜÂìÅ ${item.name} (ID: ${item.id}) ÁöÑÊúÄÊñ∞Ë≥áË®äÔºå‰øùÁïôÂéüË≥áË®ä`);
                        updatedCart.push(item);
                    }
                } catch (error) {
                    console.error(`‚ùå ÂêåÊ≠•ÂïÜÂìÅ ${item.name} (ID: ${item.id}) ÊôÇÁôºÁîüÈåØË™§:`, error);
                    updatedCart.push(item);
                }
            }

            return updatedCart;
        }

        function onQuantityInput(idx, value) {
            // Ê≠§ÂäüËÉΩÂ∑≤ÁßªÈô§Ôºå‰øùÁïôÁ©∫ÂáΩÂºèÈò≤Ê≠¢ÈåØË™§
        }

        async function removeItem(idx) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂïÜÂìÅÂóéÔºü')) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                await loadCart();
            }
        }

        function goToCheckout() {
            window.location.href = 'checkout.html';
        }

        // È°ØÁ§∫ÁµêÂ∏≥Ë°®ÂñÆ
        async function showCheckoutForm() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºÅ');
                return;
            }

            // Ê∏≤ÊüìË®ÇÂñÆÈ†ÖÁõÆ
            await renderOrderItems(cart);

            // ÂàáÊèõÈ°ØÁ§∫
            document.getElementById('cartContent').style.display = 'none';
            document.getElementById('checkoutForm').style.display = 'block';

            // ÂàùÂßãÂåñÊúÉÂì°Ë≥áÊñôÈÅ∏È†Ö
            initializeMemberDataOption();

            // Êõ¥Êñ∞ÊúÉÂì°ÈªûÊï∏È°ØÁ§∫
            updateMemberPoints();

            // Êõ¥Êñ∞Á∏ΩÈáëÈ°ç
            updateTotal();
        }

        // ÊúÉÂì°Ë≥áÊñôÂÖ®ÂüüËÆäÊï∏
        let memberData = null;
        let memberPoints = 0;

        // ÊúÉÂì°Ë≥áÊñôËá™ÂãïÂ∏∂ÂÖ•ÂäüËÉΩ
        async function initializeMemberDataOption() {
            try {
                const response = await fetch('http://localhost:8080/customers/profile', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    memberData = await response.json();
                    console.log('ÊúÉÂì°Ë≥áÊñôËºâÂÖ•ÊàêÂäü:', memberData);

                    // È°ØÁ§∫ÂãæÈÅ∏ÈÅ∏È†Ö
                    const memberDataOption = document.querySelector('.mb-4.p-3');
                    if (memberDataOption) {
                        memberDataOption.style.display = 'block';
                    }
                } else {
                    console.log('ÁÑ°Ê≥ïËºâÂÖ•ÊúÉÂì°Ë≥áÊñôÔºåÈö±ËóèÈÅ∏È†Ö');
                    const memberDataOption = document.querySelector('.mb-4.p-3');
                    if (memberDataOption) {
                        memberDataOption.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÊúÉÂì°Ë≥áÊñôÂ§±Êïó:', error);
                const memberDataOption = document.querySelector('.mb-4.p-3');
                if (memberDataOption) {
                    memberDataOption.style.display = 'none';
                }
            }
        }

        // ÂàáÊèõÊúÉÂì°Ë≥áÊñô‰ΩøÁî®ÁãÄÊÖã
        function toggleMemberData() {
            const checkbox = document.getElementById('useMemberData');
            const nameField = document.getElementById('recipientName');
            const phoneField = document.getElementById('recipientPhone');
            const emailField = document.getElementById('recipientEmail');
            const addressField = document.getElementById('recipientAddress');

            if (checkbox.checked && memberData) {
                // Â°´ÂÖ•ÊúÉÂì°Ë≥áÊñô‰∏¶Á¶ÅÁî®Ê¨Ñ‰Ωç
                nameField.value = memberData.name || '';
                phoneField.value = memberData.phone || '';
                emailField.value = memberData.email || '';
                addressField.value = memberData.address || '';

                // Ë®≠ÁÇ∫Á¶ÅÁî®ÁãÄÊÖã
                nameField.disabled = true;
                phoneField.disabled = true;
                emailField.disabled = true;
                addressField.disabled = true;

                // Ë¶ñË¶∫ÊïàÊûú
                nameField.style.backgroundColor = '#f8f9fa';
                phoneField.style.backgroundColor = '#f8f9fa';
                emailField.style.backgroundColor = '#f8f9fa';
                addressField.style.backgroundColor = '#f8f9fa';

                console.log('Â∑≤Â∏∂ÂÖ•ÊúÉÂì°Ë≥áÊñô‰∏¶ÈéñÂÆöÊ¨Ñ‰Ωç');
            } else {
                // Ê∏ÖÁ©∫‰∏¶ÂïüÁî®Ê¨Ñ‰Ωç
                nameField.value = '';
                phoneField.value = '';
                emailField.value = '';
                addressField.value = '';

                // ÊÅ¢Âæ©ÂèØÁ∑®ËºØÁãÄÊÖã
                nameField.disabled = false;
                phoneField.disabled = false;
                emailField.disabled = false;
                addressField.disabled = false;

                // ÊÅ¢Âæ©ÂéüÂßãÊ®£Âºè
                nameField.style.backgroundColor = '';
                phoneField.style.backgroundColor = '';
                emailField.style.backgroundColor = '';
                addressField.style.backgroundColor = '';

                console.log('Â∑≤Ê∏ÖÁ©∫Ê¨Ñ‰Ωç‰∏¶Ëß£Èô§ÈéñÂÆö');
            }
        }

        // Êõ¥Êñ∞ÊúÉÂì°ÈªûÊï∏È°ØÁ§∫
        async function updateMemberPoints() {
            try {
                const response = await fetch('http://localhost:8080/customers/points', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const pointsData = await response.json();
                    memberPoints = pointsData.points || 0;

                    console.log('‚úÖ ÊúÉÂì°ÈªûÊï∏ËºâÂÖ•ÊàêÂäü:', memberPoints);

                    // Êõ¥Êñ∞ÈªûÊï∏È°ØÁ§∫
                    const availablePointsSpan = document.getElementById('availablePoints');
                    const pointsInput = document.getElementById('points');
                    const pointsLabel = document.querySelector('label[for="points"]');

                    if (availablePointsSpan) {
                        availablePointsSpan.textContent = memberPoints;
                    }

                    if (pointsInput) {
                        pointsInput.max = memberPoints;
                        pointsInput.value = '0';

                        if (memberPoints > 0) {
                            pointsInput.disabled = false;
                            pointsInput.placeholder = `ÂèØ‰ΩøÁî® 0-${memberPoints} Èªû`;
                        } else {
                            pointsInput.disabled = true;
                            pointsInput.placeholder = 'ÁÑ°ÂèØÁî®ÈªûÊï∏';
                        }
                    }

                    if (pointsLabel && memberPoints <= 0) {
                        pointsLabel.innerHTML = '‰ΩøÁî®ÈªûÊï∏ <small class="text-muted">(ÁÑ°ÂèØÁî®ÈªûÊï∏)</small>';
                    }

                } else {
                    console.log('üîç ÁÑ°Ê≥ïËºâÂÖ•ÊúÉÂì°ÈªûÊï∏ÔºåÂèØËÉΩÊú™ÁôªÂÖ•');
                    memberPoints = 0;

                    // Ë®≠ÁÇ∫Êú™ÁôªÂÖ•ÁãÄÊÖã
                    const availablePointsSpan = document.getElementById('availablePoints');
                    const pointsInput = document.getElementById('points');
                    const pointsLabel = document.querySelector('label[for="points"]');

                    if (availablePointsSpan) {
                        availablePointsSpan.textContent = '0';
                    }

                    if (pointsInput) {
                        pointsInput.disabled = true;
                        pointsInput.value = '0';
                        pointsInput.placeholder = 'Ë´ãÂÖàÁôªÂÖ•';
                    }

                    if (pointsLabel) {
                        pointsLabel.innerHTML = '‰ΩøÁî®ÈªûÊï∏ <small class="text-muted">(Ë´ãÂÖàÁôªÂÖ•)</small>';
                    }
                }
            } catch (error) {
                console.error('‚ùå ËºâÂÖ•ÊúÉÂì°ÈªûÊï∏Â§±Êïó:', error);
                memberPoints = 0;

                // Ë®≠ÁÇ∫ÈåØË™§ÁãÄÊÖã
                const availablePointsSpan = document.getElementById('availablePoints');
                const pointsInput = document.getElementById('points');

                if (availablePointsSpan) {
                    availablePointsSpan.textContent = '0';
                }

                if (pointsInput) {
                    pointsInput.disabled = true;
                    pointsInput.value = '0';
                    pointsInput.placeholder = 'ËºâÂÖ•Â§±Êïó';
                }
            }
        }

        // Ê∏≤ÊüìÁµêÂ∏≥ÊòéÁ¥∞
        async function renderOrderItems(cart) {
            const orderItems = document.getElementById('orderItems');
            orderItems.innerHTML = '';
            let subtotal = 0;
            const updatedCart = await syncCartWithDatabase(cart);
            updatedCart.forEach((item, idx) => {
                const imgSrc = item.image && item.image.trim() !== '' ? item.image : 'https://via.placeholder.com/80x80?text=No+Image';
                const row = document.createElement('tr');
                row.innerHTML = `
            <td><img src="${imgSrc}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;" onerror="this.src='../images/baby.jpg';"></td>
            <td>${item.name}</td>
            <td>NT$${item.price}</td>
            <td>${item.quantity}</td>
            <td>NT$${item.price * item.quantity}</td>
            <td><button onclick="removeOrderItem(${idx})" class="btn btn-danger">Âà™Èô§</button></td>
        `;
                orderItems.appendChild(row);
                subtotal += item.price * item.quantity;
                updatePlusMinusBtnState(row, item.quantity, stockMap[item.id]);
            });
            localStorage.setItem('cart', JSON.stringify(updatedCart));
            document.getElementById('orderSubtotal').textContent = subtotal;
            document.getElementById('orderTotal').textContent = subtotal;
            document.getElementById('shippingFee').textContent = 0;
            document.getElementById('discount').textContent = 0;
            updateTotal();
        }

        // Â∑≤ÁßªÈô§ÁµêÂ∏≥ÊòéÁ¥∞ÁöÑÊï∏ÈáèË™øÊï¥ÂäüËÉΩÔºåÂÉÖÂú®Ë≥ºÁâ©ËªäÈöéÊÆµÂèØË™øÊï¥

        // ÁµêÂ∏≥ÊòéÁ¥∞Âà™Èô§
        async function removeOrderItem(idx) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂïÜÂìÅÂóéÔºü')) {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                await renderOrderItems(cart);
                updateTotal();
            }
        }

        // Èö±ËóèÁµêÂ∏≥Ë°®ÂñÆ
        function hideCheckoutForm() {
            document.getElementById('cartContent').style.display = 'block';
            document.getElementById('checkoutForm').style.display = 'none';
        }

        // ÂÆ¢Êà∂Ë≥áË®äËÆäÊõ¥ÊôÇÁöÑËôïÁêÜÂáΩÊï∏ÔºàÂ∑≤ÁôªÂÖ•ÊúÉÂì°‰∏çÈúÄË¶ÅÊ≠§ÂäüËÉΩÔºâ
        function onCustomerInfoChange() {
            // ÊúÉÂì°ÁôªÂÖ•ÂæåÔºåÈªûÊï∏ÊúÉÂú®ÈÄ≤ÂÖ•ÁµêÂ∏≥È†ÅÈù¢ÊôÇËá™ÂãïËºâÂÖ•
            // ‰∏çÈúÄË¶ÅÊ†πÊìöË°®ÂñÆËº∏ÂÖ•ÈáçÊñ∞Êü•Ë©¢
            console.log('üîÑ ÂÆ¢Êà∂Ë≥áË®äËÆäÊõ¥ÔºàÊúÉÂì°ÈªûÊï∏Â∑≤Âú®ÁôªÂÖ•ÊôÇËºâÂÖ•Ôºâ');
        }

        // ÈªûÊï∏Ëº∏ÂÖ•È©óË≠âÂíåÊõ¥Êñ∞
        function validateAndUpdatePoints() {
            const pointsInput = document.getElementById('points');
            const availablePointsSpan = document.getElementById('availablePoints');
            const pointsError = document.getElementById('pointsError');

            if (!pointsInput || !availablePointsSpan) return;

            const inputPoints = parseInt(pointsInput.value) || 0;
            const availablePoints = parseInt(availablePointsSpan.textContent) || 0;

            // Èö±ËóèÈåØË™§Ë®äÊÅØ
            if (pointsError) {
                pointsError.style.display = 'none';
            }

            // È©óË≠âÈªûÊï∏
            if (inputPoints < 0) {
                pointsInput.value = '0';
                if (pointsError) {
                    pointsError.textContent = 'ÈªûÊï∏‰∏çËÉΩÁÇ∫Ë≤†Êï∏';
                    pointsError.style.display = 'block';
                }
            } else if (inputPoints > availablePoints) {
                pointsInput.value = availablePoints.toString();
                if (pointsError) {
                    pointsError.textContent = `ÊúÄÂ§öÂè™ËÉΩ‰ΩøÁî® ${availablePoints} Èªû`;
                    pointsError.style.display = 'block';
                }
            }

            // Êõ¥Êñ∞Á∏ΩÈ°ç
            updateTotal();
        }

        // Êèê‰∫§Ë®ÇÂñÆ
        async function submitOrder(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const cart = JSON.parse(localStorage.getItem('cart')) || [];

            try {
                // Ê™¢Êü•Ë≥ºÁâ©ËªäÊòØÂê¶ÁÇ∫Á©∫
                if (cart.length === 0) {
                    throw new Error('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºÅ');
                }

                // Áç≤Âèñ‰ΩøÁî®ÁöÑÈªûÊï∏
                const pointsUsed = parseInt(document.getElementById('points').value) || 0;

                // Áõ¥Êé•ÂæûDOMÂÖÉÁ¥†Áç≤ÂèñÂÄºÔºàÈÅøÂÖçÁ¶ÅÁî®Ê¨Ñ‰ΩçÂïèÈ°åÔºâ
                const name = document.getElementById('recipientName').value.trim();
                const phone = document.getElementById('recipientPhone').value.trim();
                const email = document.getElementById('recipientEmail').value.trim();
                const address = document.getElementById('recipientAddress').value.trim();
                const paymentMethod = formData.get('paymentMethod');

                // ÂâçÁ´ØÈ©óË≠â
                if (!name || !phone || !email || !address || !paymentMethod) {
                    throw new Error('Ë´ãÂ°´ÂØ´ÂÆåÊï¥ÁöÑÊî∂‰ª∂‰∫∫Ë≥áË®äÂíå‰ªòÊ¨æÊñπÂºè');
                }

                // Ê∫ñÂÇôË®ÇÂñÆÊï∏Êìö
                const orderData = {
                    name: name,
                    phone: phone,
                    email: email,
                    address: address,
                    paymentMethod: paymentMethod,
                    pointsUsed: pointsUsed,
                    totalAmount: parseFloat(document.getElementById('orderTotal').textContent.replace(/[^0-9.-]+/g, '')),
                    items: cart.map(item => {
                        // Á¢∫‰øùÊØèÂÄãÂïÜÂìÅÈÉΩÊúâÂøÖË¶ÅÁöÑÊ¨Ñ‰Ωç
                        if (!item.id && item.id !== 0) {
                            console.error('Missing product ID for item:', item);
                            throw new Error(`ÂïÜÂìÅ "${item.name}" Áº∫Â∞ëÂïÜÂìÅIDÔºåË´ãÈáçÊñ∞Ê∑ªÂä†ÂïÜÂìÅÂà∞Ë≥ºÁâ©Ëªä`);
                        }
                        return {
                            productId: item.id,
                            name: item.name,
                            quantity: parseInt(item.quantity),
                            price: parseFloat(item.price)
                        };
                    })
                };

                console.log('üìù Ë®ÇÂñÆÊï∏Êìö:', orderData);

                // Â¶ÇÊûúÈÅ∏Êìá LINE PayÔºåÂâáÂ∞éÂêë LINE Pay ÊµÅÁ®ã
                if (paymentMethod === 'linepay') {
                    await processLinePayPayment(orderData, cart);
                    return;
                }

                if (paymentMethod === 'ecpay') {
                    await processEcpayPayment(orderData);
                    return;
                }


                // ÂÖ∂‰ªñ‰ªòÊ¨æÊñπÂºèÔºöÁôºÈÄÅË´ãÊ±ÇÂà∞ÂæåÁ´Ø - ‰ΩøÁî®ÂéüÊú¨ÁöÑAPIË∑ØÂæë
                const response = await fetch('http://localhost:8080/orders/api/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                console.log('üîç ‰º∫ÊúçÂô®ÈüøÊáâÁãÄÊÖã:', response.status);
                console.log('üîç ÈüøÊáâ Content-Type:', response.headers.get('content-type'));

                if (!response.ok) {
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫JSONÈüøÊáâ
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Ë®ÇÂñÆÂª∫Á´ãÂ§±Êïó');
                    } else {
                        // Â¶ÇÊûú‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈåØË™§È†ÅÈù¢
                        const errorText = await response.text();
                        console.error('‰º∫ÊúçÂô®ÂõûÊáâÈùûJSONÊ†ºÂºè:', errorText.substring(0, 200));
                        throw new Error(`‰º∫ÊúçÂô®ÈåØË™§ (${response.status}): APIÁ´ØÈªûÂèØËÉΩ‰∏çÂ≠òÂú®ÊàñÈÖçÁΩÆÈåØË™§`);
                    }
                }

                const result = await response.json();

                // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
                localStorage.setItem('cart', JSON.stringify([]));

                // ÊßãÂª∫ÊàêÂäüË®äÊÅØ
                let successMessage = `Ë®ÇÂñÆÂ∑≤ÊàêÂäüÂª∫Á´ãÔºÅ\nË®ÇÂñÆÁ∑®ËôüÔºö${result.orderId}`;
                if (result.pointsUsed && result.pointsUsed > 0) {
                    successMessage += `\n‰ΩøÁî®ÈªûÊï∏Ôºö${result.pointsUsed} Èªû`;
                }
                if (result.pointsEarned && result.pointsEarned > 0) {
                    successMessage += `\nÁç≤ÂæóÈªûÊï∏Ôºö${result.pointsEarned} Èªû`;
                }
                if (result.remainingPoints !== undefined) {
                    successMessage += `\nÂâ©È§òÈªûÊï∏Ôºö${result.remainingPoints} Èªû`;
                }

                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                alert(successMessage);

                // ÈáçÂÆöÂêëÂà∞Ë®ÇÂñÆÁ¢∫Ë™çÈ†ÅÈù¢
                window.location.href = 'order-confirmation.html?orderId=' + result.orderId;

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Ë®ÇÂñÆÂª∫Á´ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
            }
        }

        async function processEcpayPayment(orderData) {
            try {
                console.log('üü¢ Ê∫ñÂÇôÂ∞éÂêëÁ∂†Áïå‰ªòÊ¨æ...');

                const response = await fetch('http://localhost:8080/ecpay/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        orderNumber: 'ORDER_' + Date.now(), // Êàñ orderData.orderId
                        amount: Math.round(orderData.totalAmount),
                        item: 'PikaBaby Ë≥ºÁâ©ÂïÜÂìÅ'
                    })
                });

                const html = await response.text();

                // ÈñãÊñ∞Ë¶ñÁ™óÈÄÅÂá∫‰ªòÊ¨æË°®ÂñÆ
                const win = window.open('', '_blank');
                win.document.open();
                win.document.write(html);
                win.document.close();

                // ÂèØÈÅ∏ÔºöÂ∞áË®ÇÂñÆÂÑ≤Â≠òËµ∑‰æÜ‰æõ callback ‰ΩøÁî®
                localStorage.setItem('pendingOrder', JSON.stringify(orderData));

            } catch (error) {
                console.error('‚ùå Á∂†Áïå‰ªòÊ¨æÈåØË™§:', error);
                alert('Á∂†Áïå‰ªòÊ¨æÂàùÂßãÂåñÂ§±ÊïóÔºö' + error.message);
            }
        }


        // LINE Pay ‰ªòÊ¨æËôïÁêÜÂáΩÊï∏
        async function processLinePayPayment(orderData, cart) {
            try {
                console.log('üîÑ Ê∫ñÂÇô LINE Pay ‰ªòÊ¨æ...');

                // ÁîüÊàêÂîØ‰∏ÄË®ÇÂñÆID
                const orderId = 'ORDER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // Ê∫ñÂÇô LINE Pay Ë´ãÊ±ÇÊï∏Êìö
                const linePayRequest = {
                    amount: Math.round(orderData.totalAmount), // LINE Pay ÈúÄË¶ÅÊï¥Êï∏ÈáëÈ°ç
                    currency: 'TWD',
                    orderId: orderId,
                    packages: [{
                        id: 'PACKAGE_1',
                        amount: Math.round(orderData.totalAmount),
                        name: 'PikaBaby Ë≥ºÁâ©',
                        products: cart.map((item, index) => ({
                            id: item.id.toString(),
                            name: item.name,
                            quantity: item.quantity,
                            price: index == 0? Math.round(item.price) - orderData.pointsUsed : Math.round(item.price)
                        }))
                    }],
                    redirectUrls: {
                        confirmUrl: `${window.location.origin}/Shopping/linepay-confirm.html?orderId=${orderId}`,
                        cancelUrl: `${window.location.origin}/Shopping/shoppingcart.html?linepay=cancelled`
                    }
                };

                console.log('üìù LINE Pay Ë´ãÊ±ÇÊï∏Êìö:', linePayRequest);

                // Êö´Â≠òË®ÇÂñÆË≥áÊñôÂà∞ localStorageÔºàÁî®Êñº‰ªòÊ¨æÁ¢∫Ë™çÂæåÂª∫Á´ãÊ≠£ÂºèË®ÇÂñÆÔºâ
                localStorage.setItem('pendingOrder', JSON.stringify({
                    ...orderData,
                    orderId: orderId,
                    cart: cart
                }));

                // ÁôºÈÄÅ LINE Pay Ë´ãÊ±Ç
                const response = await fetch('http://localhost:8080/linepay/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(linePayRequest)
                });

                if (!response.ok) {
                    throw new Error('LINE Pay Ë´ãÊ±ÇÂ§±Êïó');
                }

                const result = await response.json();
                console.log('‚úÖ LINE Pay ÈüøÊáâ:', result);

                if (result.returnCode === '0000' && result.info && result.info.paymentUrl) {
                    // ÊàêÂäüÂª∫Á´ã LINE Pay ‰ªòÊ¨æË´ãÊ±ÇÔºåÂ∞éÂêë‰ªòÊ¨æÈ†ÅÈù¢
                    console.log('üîÑ Â∞éÂêë LINE Pay ‰ªòÊ¨æÈ†ÅÈù¢...');
                    window.location.href = result.info.paymentUrl.web;
                } else {
                    throw new Error('LINE Pay ÂàùÂßãÂåñÂ§±Êïó: ' + (result.returnMessage || 'Êú™Áü•ÈåØË™§'));
                }

            } catch (error) {
                console.error('‚ùå LINE Pay ‰ªòÊ¨æËôïÁêÜÂ§±Êïó:', error);
                alert('LINE Pay ‰ªòÊ¨æËôïÁêÜÂ§±ÊïóÔºö' + error.message);
            }
        }

        function updateTotal() {
            const subtotal = parseFloat(document.getElementById('orderSubtotal').textContent);
            const shippingFee = parseFloat(document.getElementById('shippingFee').textContent);
            const discountElem = document.getElementById('discount');
            const discount = discountElem ? parseFloat(discountElem.textContent) : 0;
            const points = parseInt(document.getElementById('points').value) || 0;
            const total = subtotal + shippingFee - discount - points;
            document.getElementById('orderTotal').textContent = total;
        }

        // Âä†Ë≥ºÂïÜÂìÅÂä†ÂÖ•Ë≥ºÁâ©ËªäÔºàÁµêÂ∏≥È†ÅÂ∞àÁî®Ôºâ
        async function addAddonToCart(productName, price, imageUrl, btn, productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const idx = cart.findIndex(item => item.name === productName);
            if (idx > -1) {
                cart[idx].quantity += 1;
            } else {
                if (!productId) {
                    alert('ÁÑ°Ê≥ïÂä†ÂÖ•ÂïÜÂìÅÔºöÁº∫Â∞ëÂïÜÂìÅID');
                    return;
                }
                cart.push({
                    id: productId,
                    name: productName,
                    price: price,
                    quantity: 1,
                    image: imageUrl
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            alert(`Â∑≤Â∞á ${productName} Âä†ÂÖ•Ë≥ºÁâ©ËªäÔºÅ`);
            await loadCart();
            await renderOrderItems(cart);
            updateTotal();
            // ÊåâÈàïËÆäÊàêÂ∑≤Âä†ÂÖ•‰∏î‰∏çËÉΩÂÜçÈªû
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä';
            }
        }

        // ÁØ©ÈÅ∏ÂäüËÉΩ
        function filterProducts(category) {
            // Êõ¥Êñ∞ URL ÂèÉÊï∏
            const url = new URL(window.location.href);
            url.searchParams.set('category', category);
            window.history.pushState({}, '', url);

            // Â¶ÇÊûúÁï∂ÂâçÈ†ÅÈù¢‰∏çÊòØÂïÜÂìÅÈ†ÅÈù¢ÔºåÂâáË∑≥ËΩâÂà∞ÂïÜÂìÅÈ†ÅÈù¢
            if (!window.location.pathname.includes('product.html')) {
                window.location.href = `product.html?category=${category}`;
            }
        }

        // updateQuantityËàáonQuantityInputÈÉΩË¶ÅÂç≥ÊôÇÊõ¥Êñ∞Âä†Ê∏õËôüdisabledÁãÄÊÖã
        async function updateQuantity(idx, delta) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart[idx];
            const stock = stockMap[item.id] || 99; // Áõ¥Êé•Áî®ÂÖ®Âüü stockMap
            let currentQuantity = item.quantity;
            let newQuantity = currentQuantity + delta;
            if (currentQuantity >= stock && delta > 0) {
                newQuantity = stock;
            }
            if (currentQuantity <= 1 && delta < 0) {
                newQuantity = 1;
            }
            newQuantity = Math.min(Math.max(newQuantity, 1), stock);
            cart[idx].quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            // Âè™Êõ¥Êñ∞Ë©≤Ë°å
            const cartTable = document.getElementById('cart-table');
            const row = cartTable.rows[idx + 1];
            const qtyDisplay = document.getElementById(`qty-display-${idx}`);
            if (row && qtyDisplay) {
                qtyDisplay.textContent = newQuantity;
                row.cells[4].textContent = `NT$${cart[idx].price * cart[idx].quantity}`;
                updatePlusMinusBtnState(row, newQuantity, stock);
            }
            // Êõ¥Êñ∞Á∏ΩË®à
            let total = 0;
            cart.forEach(item => { total += item.price * item.quantity; });
            document.getElementById('cart-total').textContent = `Á∏ΩË®àÔºöNT$ ${total}`;
        }

        // Áµ±‰∏ÄÊéßÂà∂Âä†Ê∏õÊåâÈàïÁãÄÊÖã
        function updatePlusMinusBtnState(row, newQuantity, stock) {
            const minusBtn = row.cells[3].querySelector('button:nth-child(1)');
            const plusBtn = row.cells[3].querySelector('button:nth-child(3)');
            if (minusBtn) minusBtn.disabled = newQuantity <= 1;
            if (plusBtn) plusBtn.disabled = newQuantity >= stock;
        }

        // Êñ∞Â¢ûÁπºÁ∫åË≥ºÁâ©ÂäüËÉΩ
        function continueShopping() {
            window.location.href = '../Products/product.html';
        }
    </script>
</body>

</html>