<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PikaBaby</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/product.css">
</head>

<body>
    <header>
        <!-- 置頂的促銷訊息 -->
        <div class="top-banner">
            每週五六日🔥新人代理寄賣免運
            <font color="red"><span></span> 日 <span></span> 時 <span></span> 分 <span></span> 秒</font>

        </div>

        <!-- LOGO -->
        <div class="nav-logo-row">
            <img src="../images/logo-pikababy.png" alt="PikaBaby" class="nav-logo" />
        </div>
    </header>
    <!-- 導覽列 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- <div class="collapse navbar-collapse justify-content-center d-flex" id="navbarSupportedContent"> -->
            <div class="collapse navbar-collapse justify-content-around d-flex" id="navbarSupportedContent">
                <!-- LOGO -->
                <img id="logo" src="../images/logo-pikababy.png" alt="PikaBaby"
                    style="height: 80px; width: 0px; display: none;" />
                <ul class="navbar-nav ml-auto nav-links gap-5 me-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../index.html">首頁</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown1" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(0-3M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown1">
                            <a class="dropdown-item" href="product.html?category=14">奶瓶/奶嘴</a>
                            <a class="dropdown-item" href="product.html?category=15">圍兜/揹巾</a>
                            <a class="dropdown-item" href="product.html?category=1">嬰兒服裝</a>
                            <a class="dropdown-item" href="product.html?category=16">清潔用品</a>
                            <a class="dropdown-item" href="product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="product.html?category=3">嬰兒床</a>
                            <a class="dropdown-item" href="product.html?category=17">哺乳用品</a>
                            <a class="dropdown-item" href="product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown2" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(3-6M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown2">
                            <a class="dropdown-item" href="product.html?category=1">嬰兒服裝</a>
                            <a class="dropdown-item" href="product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="product.html?category=3">嬰兒床</a>
                            <a class="dropdown-item" href="product.html?category=6">汽座</a>
                            <a class="dropdown-item" href="product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown3" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(6-12M)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown3">
                            <a class="dropdown-item" href="product.html?category=7">學步用品</a>
                            <a class="dropdown-item" href="product.html?category=18">餐具用品</a>
                            <a class="dropdown-item" href="product.html?category=8">幼兒服裝</a>
                            <a class="dropdown-item" href="product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="product.html?category=2">嬰兒推車</a>
                            <a class="dropdown-item" href="product.html?category=6">汽座</a>
                            <a class="dropdown-item" href="product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown4" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            年齡區間(2-3y)
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center" aria-labelledby="navbarDropdown4">
                            <a class="dropdown-item" href="product.html?category=9">幼教用品</a>
                            <a class="dropdown-item" href="product.html?category=10">兒童服裝</a>
                            <a class="dropdown-item" href="product.html?category=5">玩具</a>
                            <a class="dropdown-item" href="product.html?category=5">汽座</a>
                            <a class="dropdown-item" href="product.html?category=11">兒童推車</a>
                            <a class="dropdown-item" href="product.html?category=12">餐椅</a>
                            <a class="dropdown-item" href="product.html?category=13">電器用品</a>
                            <a class="dropdown-item" href="product.html?category=4">嬰兒用品</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            二手託售
                        </a>
                        <div class="dropdown-menu p-3 justify-content-center gap-5" aria-labelledby="navbarDropdown5">
                            <a class="dropdown-item" href="../Secondhand/consign.html">託售服務</a>
                            <a class="dropdown-item" href="../Secondhand/consign_apply.html">二手託售申請</a>
                            <a class="dropdown-item" href="../Secondhand/consign_search.html">託售紀錄查詢</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_apply.html">託售提款申請</a>
                            <a class="dropdown-item" href="../Secondhand/withdraw_search.html">提款紀錄查詢</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="../about.html">關於我們</a>
                    </li>
                    <div class="d-flex gap-3">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="../Shopping/shoppingcart.html">
                                <img src="../images/cart.png" style="width: 30px;">
                            </a>
                            <!-- <div class="dropdown-menu p-3 justify-content-center gap-5"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="Shopping/shoppingcart.html">購物車</a>
                                <a class="dropdown-item" href="Shopping/order.html">訂單查詢</a>
                            </div> -->
                        </li>
                        <!-- ✅ 未登入時：跳 login，不顯示 dropdown -->
                        <li class="nav-item" id="loginNavItem">
                            <a class="nav-link" href="../Member/login.html">
                                <img src="../images/user.png" style="width: 30px;" alt="會員登入圖示">
                            </a>
                        </li>
                        <!-- ✅ 已登入時：正常 dropdown -->
                        <li class="nav-item dropdown" id="memberDropdownItem" style="display: none;">
                            <a class="nav-link dropdown-toggle" id="navbarDropdown5" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <img src="../images/user.png" style="width: 30px;" alt="會員圖示">
                            </a>
                            <div class="dropdown-menu p-3 justify-content-center gap-5" id="dropdownForUser"
                                aria-labelledby="navbarDropdown5">
                                <a class="dropdown-item" href="../Member/member.html">會員中心</a>
                                <a class="dropdown-item text-danger" href="#" onclick="logout()">登出</a>
                            </div>
                        </li>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <main class="main-content">
        <!-- Banner圖片 -->
        <img src="../images/banner.jpg" alt="Banner" class="banner-image">

        <!-- 篩選面板 -->
        <div class="filter-container">
            <!-- 排序下拉選單 -->
            <div class="filter-section">
                <div class="filter-title">排序方式</div>
                <select class="sort-select" id="sort-select">
                    <option value="default">預設排序</option>
                    <option value="price-low-high">價格從低到高</option>
                    <option value="price-high-low">價格從高到低</option>
                    <option value="newest">最新上架</option>
                    <option value="hot">熱銷推薦</option>
                    <option value="brand">品牌</option>
                    <option value="category">商品分類</option>
                </select>
            </div>

            <!-- 商品種類篩選 -->
            <div class="filter-section">
                <div class="filter-title">商品種類</div>
                <select class="category-select" id="category-select">
                    <!-- <option value="">全部商品</option> -->
                    <!-- 動態載入的分類選項會在這裡顯示 -->
                </select>
            </div>

            <!-- 商品狀態篩選 -->
            <div class="filter-section">
                <div class="filter-title">商品狀態</div>
                <select class="condition-select" id="condition-select">
                    <option value="">全部</option>
                    <option value="new">全新商品</option>
                    <option value="used">二手商品</option>
                </select>
            </div>

            <!-- 關鍵字搜尋 -->
            <div class="filter-section">
                <div class="filter-title">關鍵字搜尋</div>
                <input type="text" class="search-box" placeholder="請輸入關鍵字...">
            </div>
        </div>

        <!-- 商品區塊 -->
        <div class="products-container">
            <!-- 載入狀態提示 -->
            <div id="loading-indicator" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <p class="mt-3 text-muted">正在從資料庫載入商品...</p>
            </div>

            <!-- 錯誤提示 -->
            <div id="error-indicator" class="alert alert-danger text-center" style="display: none;">
                <h5>🚫 載入失敗</h5>
                <p>無法從伺服器載入商品資料，請檢查後端服務是否啟動</p>
                <button class="btn btn-primary" onclick="retryLoadProducts()">重新載入</button>
            </div>

            <div id="null-indicator" class="alert alert-secondary text-center" style="display: none;">
                <h5>此類別暫無上架商品</h5>
            </div>



            <!-- 動態商品容器 -->
            <div id="dynamic-products-grid" class="products-grid">
                <!-- 從資料庫載入的商品將顯示在這裡 -->
            </div>

            <!-- 靜態商品容器已移除，完全使用資料庫商品 -->
        </div>
        </div>

    </main>

    <!-- 頁尾 -->
    <footer>
        <div class="footer-container align-items-center">
            <div class="footer-section" style="flex: 0;">
                <img src="../images/logo-pikababy.png" alt="PikaBaby" class="footer-logo" />
            </div>
            <div class="footer-section w-100">
                <p class="footer-title">PikaBaby</p>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/index.html">HOME</a>
                </p>
                <p class="mb-1">
                    <a href="/about.html">關於我們</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>品牌服務</h3>
                <div class="footer-line"></div>
                <p class="mb-1">
                    <a href="/Products/product.html">Baby Store</a>
                </p>
                <p class="mb-1">
                    <a href="/Secondhand/consign.html">二手託售</a>
                </p>
            </div>
            <div class="footer-section w-100">
                <h3>聯絡我們</h3>
                <div class="footer-line"></div>
                <p class="mb-1">聯絡電話：(04) 2326-5860</p>
                <p class="mb-1">聯絡地址：台中市南屯區公益路二段51號18樓</p>
            </div>
        </div>
    </footer>

    <!-- 購物車通知 -->
    <div class="cart-notification"></div>

    <!-- 奶瓶 -->
    <div class="floating-bottle"></div>

    <!-- 自訂彈窗 -->
    <div id="customAlert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="custom-alert-icon">🛒</div>
            <div class="custom-alert-title">已加入購物車</div>
            <div class="custom-alert-message" id="customAlertMessage">商品已成功加入購物車！</div>
            <button class="custom-alert-button" onclick="closeCustomAlert()">確定</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/navbar.js"></script>
    <script src="../js/logout.js"></script>
    <script src="../js/product.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            updateCartCount();
            // 數量控制按鈕
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const input = this.parentElement.querySelector('.quantity-input');
                    const currentValue = parseInt(input.value);

                    if (this.classList.contains('minus')) {
                        if (currentValue > 1) {
                            input.value = currentValue - 1;
                        }
                    } else {
                        if (currentValue < 99) {
                            input.value = currentValue + 1;
                        }
                    }
                });
            });

            // 加入購物車按鈕
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let cart = JSON.parse(localStorage.getItem('cart')) || [];
                    const productId = this.dataset.productId;
                    const productName = this.dataset.productName;
                    const productPrice = parseFloat(this.dataset.productPrice);
                    const quantityInput = this.parentElement.querySelector('.quantity-input');
                    const quantity = quantityInput ? parseInt(quantityInput.value) : 1;

                    // 檢查購物車中是否已有此商品
                    const existingItem = cart.find(item => item.id === productId);

                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        cart.push({
                            id: productId,
                            name: productName,
                            price: productPrice,
                            quantity: quantity,
                            image: this.closest('.product-card').querySelector('.product-image').src
                        });
                    }

                    // 保存到 localStorage
                    localStorage.setItem('cart', JSON.stringify(cart));

                    // 更新購物車數量
                    updateCartCount();

                    // 不顯示任何提示
                });
            });

            // 整合的篩選和排序功能
            // 注意：不要在這裡獲取商品，因為動態商品還沒載入
            const sortSelect = document.getElementById('sort-select');
            const categorySelect = document.getElementById('category-select');
            const conditionSelect = document.getElementById('condition-select');
            const searchBox = document.querySelector('.search-box');

            // 全局變量來存儲當前的篩選條件
            let currentFilters = {
                category: '',
                condition: '',
                search: '',
                sort: 'default'
            };


            // 修改 filterProducts 函數，使其能夠處理 URL 參數
            // window.filterProducts = function (category) {
            window.filterProducts = function (category) {
                console.log(`🔍 篩選分類: ${category}`);
                // console.log("URL:" + window.location.href);

                // 更新 URL 參數
                const url = new URL(window.location.href);
                url.searchParams.set('category', category);
                window.history.pushState({}, '', url);

                // 更新當前篩選條件（保持原始參數用於篩選邏輯）
                currentFilters.category = category;

                // 如果分類選擇器尚未設置正確的值，再次嘗試設置
                const mappedCategory = mapLegacyCategoryToProductType(category);
                const categorySelect = document.getElementById('category-select');
                if (categorySelect && categorySelect.value !== mappedCategory) {
                    updateCategorySelector(mappedCategory);
                }

                // 執行篩選
                filterAndSortProducts();
            };

            // 添加事件監聽器
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    currentFilters.sort = this.value;
                    filterAndSortProducts();
                });
            }

            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    currentFilters.category = this.value;
                    filterAndSortProducts();
                });
            }

            if (conditionSelect) {
                conditionSelect.addEventListener('change', function () {
                    currentFilters.condition = this.value;
                    filterAndSortProducts();
                });
            }

            if (searchBox) {
                // 為搜索框添加防抖動的事件監聽器
                let searchTimeout;
                searchBox.addEventListener('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        currentFilters.search = this.value;
                        filterAndSortProducts();
                    }, 300);
                });
            }

            // 商品卡片的過渡效果會在創建時自動添加

            // 不要在頁面載入時執行篩選，因為這時候還沒有商品
            console.log('📋 篩選功能已初始化，🚀 開始載入商品資料...');
            const pageCategory = window.location.href.split("=")[1]
            loadProductTypes(pageCategory); // 先載入商品分類
            loadProductsFromDatabase(); // 再載入商品
        })

        // 多分頁同步購物車數字
        window.addEventListener('storage', function (e) {
            if (e.key === 'cart') {
                updateCartCount();
            }
        });


        // 點擊背景關閉彈窗
        document.addEventListener('click', function (e) {
            const alertOverlay = document.getElementById('customAlert');
            if (e.target === alertOverlay) {
                closeCustomAlert();
            }
        });

        // ESC 鍵關閉彈窗
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeCustomAlert();
            }
        });
    </script>

</body>

</html>